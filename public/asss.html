<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Assignments | Gold and Linc Schools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fonts + Icons + Tailwind/Flowbite -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #f6f8fa;
      color: #22305a;
      min-height: 100vh;
    }
    .avatar {
      border: 2px solid #2647a6;
      background: #ddeaff;
    }
    .bg-primary { background: #2647a6; }
    .text-primary { color: #2647a6; }
    .rounded-xl { border-radius: 1rem; }
    .badge {
      display: inline-block;
      border-radius: 9999px;
      padding: 0.2em 0.8em;
      font-size: 0.91em;
      font-weight: 700;
      margin-right: 0.2em;
    }
    .badge-pending { background: #e9f0fe; color: #2647a6; }
    .badge-completed { background: #18ba89; color: #fff; }
    .badge-overdue { background: #e74c3c; color: #fff; }
    .badge-reviewed { background: #ffd600; color: #22305a; }
    .hover-link:hover { text-decoration: underline; color: #18308b; }
    /* CBT Modal Styles */
    .cbt-modal-bg {
      position: fixed; z-index: 50; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(32,40,71,0.17);
      display: none;
      align-items: center;
      justify-content: center;
    }
    .cbt-modal {
      background: #fff;
      border-radius: 1.2em;
      max-width: 700px;
      width: 96vw;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px #22305a22;
      padding: 2.4em 2em 2em 2em;
      position: relative;
      animation: cbtmodalin .2s;
    }
    @media (max-width: 600px) {
      .cbt-modal { max-width: 99vw; padding: 1.2em 0.3em 1em 0.7em; }
    }
    @keyframes cbtmodalin {
      from { transform: scale(.96) translateY(35px); opacity: 0.3;}
      to   { transform: scale(1) translateY(0); opacity: 1;}
    }
    .cbt-modal-close {
      position: absolute; top: 16px; right: 18px;
      font-size: 1.8em; color: #bbb; background: none; border: none;
      cursor: pointer;
      transition: color .15s;
      z-index: 1;
    }
    .cbt-modal-close:hover { color: #d03b41; }
    .cbt-timer {
      font-weight: bold;
      color: #18308b;
      background: #e9f0fe;
      border-radius: 0.6em;
      padding: 2px 14px;
      font-size: 1.1em;
      display: inline-block;
      margin-bottom: 1em;
      letter-spacing: 1px;
    }
    .cbt-q-block {
      border-radius: 0.7em;
      background: #f7fafd;
      border: 1.5px solid #e9f0fe;
      margin-bottom: 1.2em;
      padding: 1em 1em 0.7em 1em;
    }
    .cbt-q-block h4 { font-weight: 600; margin-bottom: 0.2em; }
    .cbt-opt-row {
      margin-bottom: 0.5em;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .cbt-opt-row label {
      font-weight: 500;
      cursor: pointer;
    }
    .cbt-modal-header {
      font-size: 1.15em;
      font-weight: bold;
      color: #22305a;
      margin-bottom: 0.7em;
    }
    .cbt-q-block img {
      max-width: 97%;
      height: auto;
      display: block;
      margin: 7px 0;
      border-radius: 7px;
      box-shadow: 0 2px 10px #0001;
    }
    .cbt-submit-btn {
      background: #18ba89;
      color: #fff;
      padding: 11px 28px;
      font-weight: bold;
      border-radius: 8px;
      font-size: 1.05em;
      border: none;
      transition: background .15s;
    }
    .cbt-submit-btn:disabled { background: #c9e8df; color: #444; }
    .cbt-feedback {
      font-weight: bold;
      color: #159d5e;
      padding: 0.7em 0 0 0;
      font-size: 1.1em;
    }
    .cbt-loader {
      display: flex; align-items: center; justify-content: center; color: #1e88e5;
      font-weight: bold; font-size: 1.1em; gap: 12px; margin: 1.5em 0;
    }
  </style>
</head>
<body>
  <!-- Top Navbar -->
  <nav class="bg-white shadow-md rounded-b-2xl py-4 px-6 flex items-center justify-between sticky top-0 z-10">
    <div class="flex items-center gap-3">
      <img src="https://goldlincschools.com/assets/media/logos/favicon.ico" class="h-9 w-9 rounded-lg shadow" alt="Logo">
      <span class="text-xl font-bold text-primary">Assignments</span>
    </div>
    <div class="flex items-center gap-4">
      <button class="hidden md:inline-block px-4 py-2 rounded-lg bg-primary text-white font-semibold hover:bg-[#18308b] transition" onclick="window.location.href='student-dashboard.html'">
        <i class="fa fa-arrow-left mr-1"></i> Dashboard
      </button>
      <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.href='profile.html'">
        <img id="profileAvatar" class="rounded-full h-8 w-8 avatar" src="https://ui-avatars.com/api/?name=Student&background=2647a6&color=fff" alt="Student">
        <div class="text-sm font-bold text-primary" id="profileName">Student Name</div>
      </div>
    </div>
  </nav>
  <!-- Main Content -->
  <main class="max-w-4xl mx-auto mt-8 px-2">
    <!-- Assignments Table -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8">
      <h1 class="text-xl font-bold text-primary mb-2 flex items-center gap-2"><i class="fa fa-file-alt"></i> My Assignments</h1>
      <div class="overflow-x-auto mt-5">
        <table class="min-w-full text-sm">
          <thead class="bg-[#e9f0fe]">
            <tr>
              <th class="py-3 px-4 text-left font-bold text-primary">Title</th>
              <th class="py-3 px-4 text-left font-bold text-primary">Subject</th>
              <th class="py-3 px-4 text-left font-bold text-primary">Due Date</th>
              <th class="py-3 px-4 text-left font-bold text-primary">Status</th>
              <th class="py-3 px-4 text-left font-bold text-primary">Score</th>
              <th class="py-3 px-4 text-left font-bold text-primary">Action</th>
            </tr>
          </thead>
          <tbody id="assignmentsTableBody" class="bg-white divide-y divide-[#e9f0fe]">
            <tr><td class="py-2 px-4" colspan="6">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Assignment Details Modal -->
    <div id="assignmentModal" tabindex="-1" class="hidden fixed top-0 left-0 right-0 z-50 w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[100vh] max-h-full bg-black bg-opacity-40">
      <div class="relative w-full max-w-lg max-h-full mx-auto mt-20">
        <div class="relative bg-white rounded-lg shadow p-6">
          <button type="button" class="absolute top-2 right-2 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-2 ml-auto inline-flex items-center" onclick="closeAssignmentModal()">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
          </button>
          <h3 class="text-xl font-bold mb-2 text-primary" id="modalTitle">Assignment Details</h3>
          <div class="mb-2 text-gray-700" id="modalSubject"></div>
          <div class="mb-2 text-sm text-gray-500" id="modalDue"></div>
          <div class="mb-2" id="modalDescription"></div>
          <div class="mb-3" id="modalUploadSection"></div>
          <div id="modalSubmissionStatus" class="mb-2"></div>
        </div>
      </div>
    </div>
    <!-- CBT/Mock Modal -->
    <div id="cbtModalBg" class="cbt-modal-bg">
      <div class="cbt-modal" id="cbtModal">
        <button class="cbt-modal-close" onclick="closeCbtModal()">&times;</button>
        <div class="cbt-modal-header" id="cbtModalHeader"></div>
        <div class="text-center mb-2">
          <span class="cbt-timer" id="cbtTimer"></span>
        </div>
        <form id="cbtQuizForm">
          <div id="cbtQuestionsBlock"></div>
          <div class="mt-6 flex flex-col items-center">
            <button type="submit" class="cbt-submit-btn" id="cbtSubmitBtn">Submit CBT</button>
            <div id="cbtFeedback" class="cbt-feedback"></div>
          </div>
        </form>
        <div id="cbtQuizLoader" class="cbt-loader" style="display:none;"><i class="fa fa-spinner fa-spin"></i> Loading CBT...</div>
      </div>
    </div>
  </main>
  <script>
    // Backend API
    const API_BASE = "https://goldlincschools.onrender.com/api";
    const token =
      localStorage.getItem('student_token') ||
      localStorage.getItem('studentToken') ||
      localStorage.getItem('token');
    // Profile filling
    function fillProfile(data) {
      document.getElementById('profileName').textContent = data.name || 'Student Name';
      document.getElementById('profileAvatar').src = data.photo_url
        ? data.photo_url
        : 'https://ui-avatars.com/api/?name=' + encodeURIComponent(data.name || 'Student') + '&background=2647a6&color=fff';
    }

    // Fetch and fill assignments
    async function fetchAssignments() {
      try {
        // Student profile for name/avatar (for nav)
        const resProfile = await fetch(API_BASE + "/student/me", {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const student = await resProfile.json();
        fillProfile(student);

        // Main assignments
        const res = await fetch(API_BASE + "/assignments/me", {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error("Failed to fetch assignments");
        const assignments = await res.json();

        const tbody = document.getElementById('assignmentsTableBody');
        if (!assignments.length) {
          tbody.innerHTML = `<tr><td class="py-2 px-4" colspan="6">No assignments found.</td></tr>`;
          return;
        }

        tbody.innerHTML = assignments.map((a, i) => {
          // Status badge
          let statusClass = "badge-pending", statusLabel = "Pending";
          if (a.status === "Completed" || a.status === "Submitted") { statusClass = "badge-completed"; statusLabel = "Submitted"; }
          if (a.status === "Reviewed") { statusClass = "badge-reviewed"; statusLabel = "Reviewed"; }
          if (a.status === "Overdue" || (a.dueDate && new Date(a.dueDate) < new Date() && !a.submitted)) { statusClass = "badge-overdue"; statusLabel = "Overdue"; }
          // Score
          let score = a.score !== undefined && a.score !== null ? `${a.score}/${a.totalScore || 100}` : "-";
          // Action button: CBT or regular
          let cbtBtn = (a.cbt) ?
            `<button class="text-green-700 hover-link font-bold" onclick="openCbtModal('${a.cbt}','${a.subject && a.subject.name ? a.subject.name : a.subject}','${a.title.replace(/'/g,"&#39;")}')"><i class='fa fa-lightbulb'></i> Mock/CBT</button>`
            : `<button class="text-primary hover-link font-bold" onclick="openAssignmentModal(${i})"><i class="fa fa-eye"></i> View</button>`;
          return `
            <tr>
              <td class="py-2 px-4 font-semibold">${a.title}</td>
              <td class="py-2 px-4">${a.subject?.name || a.subject || ''}</td>
              <td class="py-2 px-4">${a.dueDate ? a.dueDate.slice(0,10) : ''}</td>
              <td class="py-2 px-4"><span class="badge ${statusClass}">${statusLabel}</span></td>
              <td class="py-2 px-4">${score}</td>
              <td class="py-2 px-4">${cbtBtn}</td>
            </tr>
          `;
        }).join('');

        // Store assignments globally for modal use
        window._assignments = assignments;
      } catch (err) {
        document.getElementById('assignmentsTableBody').innerHTML = `<tr><td class="py-2 px-4" colspan="6">Unable to load assignments.</td></tr>`;
      }
    }

    // Modal logic for regular assignment
    function openAssignmentModal(idx) {
      const a = window._assignments[idx];
      document.getElementById('modalTitle').textContent = a.title;
      document.getElementById('modalSubject').innerHTML = `<strong>Subject:</strong> ${a.subject?.name || a.subject || ''}`;
      document.getElementById('modalDue').innerHTML = `<strong>Due:</strong> ${a.dueDate ? a.dueDate.slice(0,16).replace('T',' ') : 'N/A'}`;
      document.getElementById('modalDescription').innerHTML = `<strong>Description:</strong><br>${(a.description || '').replace(/\n/g,'<br>')}`;
      // Submission
      let uploadSection = '';
      if (a.status === "Reviewed") {
        uploadSection += `<div class="my-2"><strong>Feedback:</strong><br>${a.feedback || 'No feedback.'}</div>`;
      }
      if (!a.submitted && (!a.status || a.status === "Pending" || a.status === "Overdue")) {
        uploadSection += `
          <form id="uploadForm" class="mt-2" enctype="multipart/form-data">
            <label class="block mb-2 font-bold text-primary" for="submissionFile">Upload your work:</label>
            <input type="file" name="file" id="submissionFile" required class="mb-2 block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-[#18308b]"/>
            <button type="submit" class="bg-primary text-white px-5 py-2 rounded-lg font-bold hover:bg-[#18308b] transition"><i class="fa fa-upload mr-1"></i>Submit</button>
          </form>
        `;
      } else if (a.submitted) {
        uploadSection += `<div class="mb-2"><span class="badge badge-completed">Submitted</span></div>`;
        if (a.submissionFile) {
          uploadSection += `<div><a class="text-primary hover-link" href="${a.submissionFile}" target="_blank"><i class="fa fa-download"></i> View Submission</a></div>`;
        }
      }
      document.getElementById('modalUploadSection').innerHTML = uploadSection;

      // Submission status
      let statusMsg = '';
      if (a.status === "Reviewed" && a.score !== undefined && a.score !== null) {
        statusMsg = `<div class="font-bold text-green-600">Score: ${a.score}/${a.totalScore || 100}</div>`;
      } else if (a.status === "Overdue" || (!a.submitted && a.dueDate && new Date(a.dueDate) < new Date())) {
        statusMsg = `<div class="font-bold text-red-600">This assignment is overdue!</div>`;
      }
      document.getElementById('modalSubmissionStatus').innerHTML = statusMsg;

      // Add upload event if form present
      if (document.getElementById('uploadForm')) {
        document.getElementById('uploadForm').onsubmit = function(ev) {
          ev.preventDefault();
          submitAssignment(a._id || a.id);
        }
      }
      document.getElementById('assignmentModal').classList.remove('hidden');
    }
    function closeAssignmentModal() {
      document.getElementById('assignmentModal').classList.add('hidden');
    }
    window.onclick = function(e) {
      const modal = document.getElementById('assignmentModal');
      const cbtModalBg = document.getElementById('cbtModalBg');
      if (!modal.classList.contains('hidden') && e.target === modal) closeAssignmentModal();
      if (cbtModalBg.style.display === 'flex' && e.target === cbtModalBg) closeCbtModal();
    }

    // Submission logic
    async function submitAssignment(assignmentId) {
      const fileInput = document.getElementById('submissionFile');
      if (!fileInput.files.length) return alert('Please select a file.');
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      try {
        const res = await fetch(`${API_BASE}/assignments/${assignmentId}/submit`, {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: formData
        });
        if (!res.ok) throw new Error("Failed to submit assignment.");
        alert("Submission successful!");
        closeAssignmentModal();
        fetchAssignments();
      } catch {
        alert("Failed to submit assignment. Please try again.");
      }
    }

    // --- CBT/Mock Modal Logic ---
    let cbtTimerInterval = null;
    let cbtStartTime = null;
    let cbtDuration = 0;
    let cbtQuestions = [];
    let cbtAnswers = [];
    let cbtAssignmentId = null;
    let cbtExamId = null;

    async function openCbtModal(cbtId, subject, title) {
      // Reset
      cbtQuestions = []; cbtAnswers = [];
      cbtAssignmentId = null; cbtExamId = null;
      document.getElementById('cbtModalHeader').innerHTML = `<i class="fa fa-lightbulb text-green-600"></i> ${subject} <span class="font-normal">(${title})</span>`;
      document.getElementById('cbtQuestionsBlock').innerHTML = '';
      document.getElementById('cbtFeedback').innerHTML = '';
      document.getElementById('cbtSubmitBtn').disabled = false;
      document.getElementById('cbtQuizLoader').style.display = '';
      document.getElementById('cbtQuizForm').style.display = 'none';
      document.getElementById('cbtTimer').textContent = '--:--';
      document.getElementById('cbtModalBg').style.display = 'flex';

      // Find assignment id for submission (from global assignments)
      const a = (window._assignments||[]).find(ass=>ass.cbt && ass.cbt._id ? ass.cbt._id === cbtId : ass.cbt === cbtId);
      cbtAssignmentId = a?._id || a?.id;
      cbtExamId = cbtId;

      // Fetch CBT info
      let cbt = null;
      try {
        const res = await fetch(`${API_BASE}/cbt/${cbtId}`, { headers: { 'Authorization': 'Bearer ' + token } });
        if (!res.ok) throw new Error();
        const data = await res.json();
        cbt = data.cbt || data;
      } catch {
        document.getElementById('cbtQuizLoader').innerHTML = `<span class="text-red-600">Failed to load CBT.</span>`;
        return;
      }
      // Timer
      cbtDuration = cbt.duration || 30;
      cbtQuestions = cbt.questions || [];
      cbtAnswers = Array(cbtQuestions.length).fill(null);

      // Render questions
      let qHtml = cbtQuestions.map((q, i) => `
        <div class="cbt-q-block">
          <h4>Q${i+1}:</h4>
          <div class="mb-2">${q.text}</div>
          <div>
            ${(q.options||[]).map((opt, oi) => `
              <div class="cbt-opt-row">
                <input type="radio" id="cbt-q${i}-opt${oi}" name="cbt-q${i}" value="${oi}" required onclick="cbtAnswers[${i}]=${oi}">
                <label for="cbt-q${i}-opt${oi}">${opt.value || opt}</label>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
      document.getElementById('cbtQuestionsBlock').innerHTML = qHtml;
      document.getElementById('cbtQuizLoader').style.display = 'none';
      document.getElementById('cbtQuizForm').style.display = '';

      // Start timer
      cbtStartTime = Date.now();
      updateCbtTimer();
      clearInterval(cbtTimerInterval);
      cbtTimerInterval = setInterval(updateCbtTimer, 1000);

      // Reset feedback
      document.getElementById('cbtFeedback').innerHTML = '';
    }

    function closeCbtModal() {
      document.getElementById('cbtModalBg').style.display = 'none';
      clearInterval(cbtTimerInterval);
    }

    function updateCbtTimer() {
      if (!cbtStartTime) return;
      const elapsed = Math.floor((Date.now() - cbtStartTime)/1000);
      const left = Math.max(0, cbtDuration*60 - elapsed);
      const min = Math.floor(left/60), sec = left%60;
      document.getElementById('cbtTimer').textContent = min.toString().padStart(2,'0')+':'+sec.toString().padStart(2,'0');
      if (left === 0) { // Time up!
        clearInterval(cbtTimerInterval);
        document.getElementById('cbtFeedback').innerHTML = `<span class="text-red-600">Time is up! Submitting your CBT...</span>`;
        setTimeout(()=>{ submitCbtQuiz(); }, 1200);
        document.getElementById('cbtSubmitBtn').disabled = true;
      }
    }

    // CBT Quiz submission
    document.getElementById('cbtQuizForm').onsubmit = function(ev) {
      ev.preventDefault();
      submitCbtQuiz();
    };

    async function submitCbtQuiz() {
      document.getElementById('cbtSubmitBtn').disabled = true;
      // Get answers from radio inputs
      let answers = [];
      for (let i=0; i<cbtQuestions.length; i++) {
        let sel = document.querySelector(`input[name="cbt-q${i}"]:checked`);
        answers[i] = sel ? Number(sel.value) : null;
      }
      // Score calculation (optional, for instant feedback)
      let score = 0, total = cbtQuestions.length;
      for (let i=0; i<cbtQuestions.length; i++) {
        if (answers[i] !== null && answers[i] === cbtQuestions[i].answer) score++;
      }
      // Show feedback
      document.getElementById('cbtFeedback').innerHTML = `Submitted! Your score: <span class="text-green-600">${score}</span> / ${total}`;
      // Optionally send to backend for saving
      if (cbtAssignmentId) {
        try {
          await fetch(`${API_BASE}/assignments/${cbtAssignmentId}/submit`, {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify({
              cbt: cbtExamId,
              answers,
              score,
              totalScore: total,
              status: "Submitted"
            })
          });
        } catch {}
      }
      setTimeout(()=>{
        closeCbtModal();
        fetchAssignments();
      }, 2200);
    }
    // Initial load
    fetchAssignments();
  </script>
</body>
</html>
