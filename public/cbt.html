<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gold and Linc Schools | Central Computer Based Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Flowbite + TailwindCSS + FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #f7fafd;
      color: #1a2b4b;
      min-height: 100vh;
      margin: 0;
    }
    .cbt-option {
      cursor: pointer;
      transition: box-shadow 0.18s, background 0.18s;
      background: #ffffff;
      border: 2px solid #ddeaff;
      word-break: break-word;
      max-width: 100%;
      overflow-x: auto;
    }
    .cbt-option.selected {
      background: #2647a6;
      color: #fff;
      border-color: #2647a6;
      box-shadow: 0 4px 18px #ddeaff99;
    }
    .cbt-option:hover {
      background: #e9f0fe;
      border-color: #2647a6;
    }
    .cbt-btn {
      padding: 0.9em 2em;
      border-radius: 0.6em;
      background: #2647a6;
      color: #fff;
      font-weight: 700;
      border: none;
      transition: background 0.18s;
      margin: 0 0.5em;
      box-shadow: 0 2px 12px #ddeaff99;
      white-space: nowrap;
    }
    .cbt-btn:disabled {
      background: #bfcde7;
      color: #888;
    }
    .cbt-btn:hover:not(:disabled) {
      background: #18308b;
    }
    .cbt-timer {
      font-weight: bold;
      font-size: 1.08em;
      background: #e9f0fe;
      color: #2647a6;
      padding: 0.6em 1.2em;
      border-radius: 0.5em;
      margin-bottom: 1em;
      display: inline-block;
      box-shadow: 0 1px 7px #ddeaff88;
      white-space: nowrap;
      max-width: 100%;
    }
    .cbt-summary {
      background: #fff;
      border-radius: 1em;
      box-shadow: 0 2px 14px #ddeaff77;
      padding: 1.7em 1.5em;
      margin-bottom: 1.2em;
      min-width: 250px;
      font-size: 1em;
      max-width: 100%;
      overflow-x: auto;
    }
    .cbt-question-nav button {
      width: 32px; height: 32px;
      margin: 0.2em;
      border-radius: 0.4em;
      border: 1.5px solid #ddeaff;
      background: #f6f8fa;
      font-weight: 700;
      color: #2647a6;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }
    .cbt-question-nav button.answered {
      background: #2647a6;
      color: #fff;
      border-color: #2647a6;
    }
    .cbt-question-nav button.current {
      background: #ffd600;
      border-color: #ffd600;
      color: #22305a;
    }
    .cbt-question-nav button:hover {
      background: #e9f0fe;
    }
    .ql-editor img, .cbt-question img, .cbt-option img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 8px auto;
      border-radius: 0.3em;
      background: #f6f8fa;
      box-shadow: 0 1px 6px #ddeaff33;
    }
    /* Prevent overflow */
    .cbt-content, .cbt-sidebar {
      max-width: 100vw;
      overflow-x: auto;
    }
    .cbt-content * {
      box-sizing: border-box;
      max-width: 100%;
      word-break: break-word;
    }

    @media (max-width: 950px) {
      .cbt-main { flex-direction: column; }
      .cbt-sidebar { width: 100%; margin-bottom: 1.5em; }
      .cbt-content { width: 100%; }
    }
    @media (max-width: 700px) {
      .cbt-content, .cbt-sidebar, .cbt-main, body, html {
        width: 100vw !important;
        max-width: 100vw !important;
        overflow-x: hidden !important;
      }
      .cbt-option {
        font-size: 1em;
        padding: 1em 0.7em;
        min-width: 0;
      }
    }
  </style>
</head>
<body>
  <div class="flex flex-col items-center w-full min-h-screen py-6 bg-[#f7fafd]">
    <div class="w-full max-w-6xl flex cbt-main gap-8 px-3 py-2">
      <!-- Sidebar: Student Details & Navigation -->
      <aside class="cbt-sidebar bg-white rounded-2xl shadow-lg p-7 flex flex-col items-center gap-5 min-w-[230px] max-w-sm">
        <div class="text-2xl font-bold text-primary mb-2 text-center">GOLD AND LINC SCHOOLS</div>
        <div class="text-lg font-semibold mb-2 text-center">CENTRAL COMPUTER BASED TEST</div>
        <div class="cbt-summary w-full">
          <div class="flex items-center gap-3 mb-3">
            <div class="rounded-full bg-[#ddeaff] text-[#2647a6] font-bold text-xl flex items-center justify-center w-14 h-14 shadow avatar">
              <i class="fa fa-desktop"></i>
            </div>
            <div>
              <div class="font-bold text-lg" id="studentName">Student Name</div>
              <div class="text-sm text-gray-600" id="studentClass">Class: -</div>
            </div>
          </div>
          <div class="text-sm mb-1" id="cbtSubject">Subject: -</div>
          <div class="text-sm mb-1">Questions: <span id="cbtTotalQuestions">-</span></div>
          <div class="text-sm mb-1">Answered: <span id="cbtTotalAnswered">0</span></div>
          <div class="text-sm mb-1">Left: <span id="cbtTotalLeft">-</span></div>
        </div>
        <div class="cbt-question-nav flex flex-wrap justify-center w-full mb-3" id="cbtQuestionNav"></div>
        <div class="cbt-timer text-center" id="cbtTimer"></div>
      </aside>
      <!-- Main CBT Content -->
      <main class="cbt-content flex-1 bg-white rounded-2xl shadow-lg p-8 flex flex-col gap-7">
        <div id="cbtExamLoader" class="text-center text-lg text-gray-500 py-16">Loading exam...</div>
        <div id="cbtExamArea" class="hidden">
          <div class="text-lg font-bold text-primary mb-3" id="cbtTestTitle"></div>
          <div class="text-base font-semibold mb-2 cbt-question" id="cbtQuestionText"></div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mt-4" id="cbtOptions">
            <!-- Options go here -->
          </div>
          <div class="flex items-center gap-2 mt-6 flex-wrap">
            <button class="cbt-btn" id="cbtPrevBtn"><i class="fa fa-arrow-left mr-1"></i> Previous</button>
            <button class="cbt-btn" id="cbtNextBtn">Next <i class="fa fa-arrow-right ml-1"></i></button>
            <button class="cbt-btn" id="cbtSubmitBtn"><i class="fa fa-paper-plane mr-1"></i> Submit</button>
          </div>
        </div>
        <div id="cbtResultArea" class="hidden"></div>
        <div id="cbtNoExamArea" class="hidden text-center text-lg text-gray-500 py-16"></div>
      </main>
    </div>
  </div>
  <script>
    // Backend API URL (adjust if needed)
    const API_BASE_URL = "https://goldlincschools.onrender.com";
    // AUTH
    const token = localStorage.getItem('student_token') || localStorage.getItem('studentToken') || localStorage.getItem('token');
    let student = { name: '', class: '', subject: '', avatar: '' };
    let exam = null;
    let startedAt = new Date().toISOString();
    let questions = [];
    let answers = [];
    let currentQ = 0;
    let timerSeconds = 0;
    let timerInterval = null;
// Helper to send student activity
async function logStudentActivity(action, extra = {}) {
  // Prepare payload
  const payload = {
    student: student._id,         // Student's MongoDB ID
    exam: exam._id,               // Exam's MongoDB ID
    action: action,               // e.g., 'started', 'answered', 'navigated', 'submitted'
    timestamp: new Date().toISOString()
                        // Additional info (questionIndex, answer, etc)
  };

  try {
    await fetch(API_BASE_URL + '/api/activity', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(token ? { 'Authorization': 'Bearer ' + token } : {})
      },
      body: JSON.stringify(payload)
    });
    // Optionally, handle/log success or failure
  } catch (e) {
    // Optionally, log errors for debug
    // console.error('Activity log failed', e);
  }
}
    // --- Fetch student info and scheduled exam ---
    async function fetchStudentAndExam() {
      // 1. Fetch student info
      let studentRes = await fetch(API_BASE_URL + '/api/student/me', {
        headers: token ? { 'Authorization': 'Bearer ' + token } : {}
      });
      if (!studentRes.ok) {
        document.getElementById('cbtExamLoader').textContent = 'Failed to load student data. Please login again.';
        return;
      }
      const studentJson = await studentRes.json();
student.name = studentJson.name || 
    ((studentJson.firstname && studentJson.surname) ? studentJson.firstname + " " + studentJson.surname : "Student Name");

// If studentJson.class is an object, try to use .name, else use as string, else fallback to '-'
student.class = 
    (typeof studentJson.class === 'object' && studentJson.class && studentJson.class.name) ? studentJson.class.name :
    (typeof studentJson.class === 'string' ? studentJson.class : '-');

student.avatar = studentJson.photo_url || '';
      student._id = studentJson._id;
let scheduledRes = await fetch(
  API_BASE_URL + '/api/exam/student?status=Scheduled,Started&scheduledFor=student',
  { headers: token ? { 'Authorization': 'Bearer ' + token } : {} }
);
      let scheduled = [];
      if (scheduledRes.ok) {
        scheduled = await scheduledRes.json();
      }
      if (!Array.isArray(scheduled) || !scheduled.length) {
        showNoExam();
        return;
      }
      // For now, pick the first scheduled exam
      exam = scheduled[0];
      questions = Array.isArray(exam.questions) ? exam.questions : [];
      answers = Array(questions.length).fill(null);
      timerSeconds = (exam.duration || 15) * 60;
      currentQ = 0;
      // Fill sidebar and render question
      document.getElementById('cbtExamLoader').style.display = 'none';
      document.getElementById('cbtExamArea').style.display = '';
      document.getElementById('cbtExamArea').classList.remove('hidden');
      fillStudentSidebar();
      renderQuestion();
      startTimer();
      // After exam and student objects are set and exam is about to begin
logStudentActivity('started');
    }

    function showNoExam() {
      document.getElementById('cbtExamLoader').style.display = 'none';
      document.getElementById('cbtNoExamArea').style.display = '';
      document.getElementById('cbtNoExamArea').classList.remove('hidden');
      document.getElementById('cbtNoExamArea').innerHTML =
        "No CBT exam is currently scheduled for you. If you believe this is an error, please contact your teacher.";
    }

    function fillStudentSidebar() {
      document.getElementById('studentName').textContent = student.name || 'Student Name';
      document.getElementById('studentClass').textContent = "Class: " + (student.class || '-');
      document.getElementById('cbtSubject').textContent = "Subject: " + (exam?.subjectName || exam?.subject?.name || '-');
      document.getElementById('cbtTotalQuestions').textContent = questions.length;
      document.getElementById('cbtTotalAnswered').textContent = answers.filter(a => a !== null).length;
      document.getElementById('cbtTotalLeft').textContent = answers.filter(a => a === null).length;

      // Question navigation
      let navHtml = "";
      for (let i = 0; i < questions.length; i++) {
        let btnClass = "";
        if (i === currentQ) btnClass = "current";
        else if (answers[i] !== null) btnClass = "answered";
        navHtml += `<button type="button" class="${btnClass}" onclick="gotoQuestion(${i})">${i + 1}</button>`;
      }
      document.getElementById('cbtQuestionNav').innerHTML = navHtml;
    }

    function renderQuestion() {
      document.getElementById('cbtTestTitle').textContent =
        (exam?.subjectName || exam?.subject?.name || '-') + " — " + (student.class || '-');
      // Render question (HTML, images safe)
      const q = questions[currentQ];
      document.getElementById('cbtQuestionText').innerHTML =
        `<div style="overflow-x:auto;max-width:100vw;" class="cbt-question">${q.text}</div>`;

      // Render options
      let optsHtml = "";
      (q.options || []).forEach((opt, idx) => {
        let selected = answers[currentQ] === idx ? "selected" : "";
        // opt may be string (HTML) or object with .value
        let optValue = typeof opt === 'string' ? opt : (opt.value || '');
        optsHtml += `
          <div class="cbt-option flex flex-col items-center justify-center gap-2 p-5 rounded-xl text-base font-bold ${selected}"
            onclick="selectAnswer(${idx})">
            <span class="text-base font-bold mb-2">(${String.fromCharCode(65 + idx)})</span>
            <span style="width:100%;overflow-x:auto;display:block;">${optValue}</span>
          </div>
        `;
      });
      document.getElementById('cbtOptions').innerHTML = optsHtml;

      document.getElementById('cbtPrevBtn').disabled = currentQ === 0;
      document.getElementById('cbtNextBtn').disabled = currentQ === questions.length - 1;
      document.getElementById('cbtSubmitBtn').disabled = answers.filter(a => a !== null).length !== questions.length;

      fillStudentSidebar();
    }

    window.gotoQuestion = function (qIdx) {
  currentQ = qIdx;
  renderQuestion();
  logStudentActivity('navigated', { questionIndex: qIdx });
}

    window.selectAnswer = function (idx) {
  answers[currentQ] = idx;
  renderQuestion();
  logStudentActivity('answered', { questionIndex: currentQ, answer: idx });
}

    document.getElementById('cbtPrevBtn').onclick = function () {
      if (currentQ > 0) {
        currentQ--;
        renderQuestion();
      }
    };
    document.getElementById('cbtNextBtn').onclick = function () {
      if (currentQ < questions.length - 1) {
        currentQ++;
        renderQuestion();
      }
    };
    document.getElementById('cbtSubmitBtn').onclick = async function () {
      if (!exam || !student) return;
      if (confirm("Are you sure you want to submit?")) {
        clearInterval(timerInterval);
        await submitExam();
      }
    };

    // ---- Timer Logic ----
    function formatTimer(s) {
      const m = Math.floor(s / 60);
      const sec = s % 60;
      return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }
    function startTimer() {
      document.getElementById('cbtTimer').textContent = "Time Left: " + formatTimer(timerSeconds);
      timerInterval = setInterval(() => {
        timerSeconds--;
        document.getElementById('cbtTimer').textContent = "Time Left: " + formatTimer(timerSeconds);
        if (timerSeconds <= 0) {
          clearInterval(timerInterval);
          alert("Time is up! Submitting your test.");
          submitExam();
        }
      }, 1000);
    }

    // ---- Submit & Result Display ----
    async function submitExam() {
      // POST /api/results
      document.getElementById('cbtExamArea').classList.add('hidden');
      document.getElementById('cbtResultArea').classList.remove('hidden');
      document.getElementById('cbtResultArea').innerHTML = '<div class="text-center text-lg text-primary py-14">Submitting your answers...</div>';

      const payload = {
  exam: exam._id,
  answers,
  class: class._id,
  student: student._id,
  startedAt: startedAt,   // you need to record when the test starts!
  finishedAt: new Date().toISOString()
};
      let result = null;
      try {
        const res = await fetch(API_BASE_URL + '/api/result', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(token ? { 'Authorization': 'Bearer ' + token } : {})
          },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          result = await res.json();
        }
      } catch {}
      logStudentActivity('submitted', { answers });
  
      showResults(result);
    }

  function showResults(result) {
  // If result is not returned (API not implemented), fallback to local check
  let correct = 0;
  let total = questions.length;
  let resultHtml = "<h2 class='text-xl font-bold mb-2 text-primary'>Test Submitted</h2>";
  resultHtml += `<div class='mb-3'>Thank you, <b>${student.name}</b>!<br>Here are your results:</div><ul class='mb-3'>`;

  if (result && result.results && Array.isArray(result.results)) {
    // If backend returns detailed answers
    result.results.forEach((q, i) => {
      let isCorrect = q.isCorrect;
      if (isCorrect) correct++;
      resultHtml += `<li class="mb-2 text-base">${questions[i].text}<br>
        <b>Your Ans:</b> ${typeof answers[i] === 'number' ? String.fromCharCode(65+answers[i]) : '<span class="text-red-600">No Answer</span>'} |
        <b>Correct:</b> ${typeof q.correctAnswer === 'number' ? String.fromCharCode(65+q.correctAnswer) : '-'}
        ${isCorrect ? "<span class='text-green-600 ml-2'>✔️</span>" : "<span class='text-red-600 ml-2'>❌</span>"}
      </li>`;
    });
  } else {
    // Fallback to local check (if backend does not validate)
    questions.forEach((q, i) => {
      let correctIdx = typeof q.answer === 'number' ? q.answer : (typeof q.answer === 'string' ? q.options.findIndex(o => o.key === q.answer) : null);
      let isCorrect = answers[i] === correctIdx;
      if (isCorrect) correct++;
      resultHtml += `<li class="mb-2 text-base">${q.text}<br>
        <b>Your Ans:</b> ${typeof answers[i] === 'number' ? String.fromCharCode(65+answers[i]) : '<span class="text-red-600">No Answer</span>'} |
        <b>Correct:</b> ${typeof correctIdx === 'number' ? String.fromCharCode(65+correctIdx) : '-'}
        ${isCorrect ? "<span class='text-green-600 ml-2'>✔️</span>" : "<span class='text-red-600 ml-2'>❌</span>"}
      </li>`;
    });
  }
  resultHtml += "</ul>";
  resultHtml += `<div class="font-bold text-lg text-primary">Score: ${correct} / ${total}</div>`;
  // --- LOGOUT BUTTON ---
  resultHtml += `<button id="cbtLogoutBtn" class="cbt-btn mt-5" style="margin-top:2em;">Log Out</button>`;

  document.getElementById('cbtResultArea').innerHTML = `<div class="py-8">${resultHtml}</div>`;
  document.getElementById('cbtTimer').textContent = '';
  document.getElementById('cbtQuestionNav').innerHTML = '';

  // Attach logout handler
  const logoutBtn = document.getElementById('cbtLogoutBtn');
  if (logoutBtn) {
    logoutBtn.onclick = function() {
      localStorage.removeItem('student_token');
      localStorage.removeItem('studentToken');
      localStorage.removeItem('token');
      window.location.href = '/cbt-login.html';
    };
  }
}

    // --- INIT ---
    fetchStudentAndExam();
    // Make functions globally accessible for event handlers
    window.gotoQuestion = window.gotoQuestion;
    window.selectAnswer = window.selectAnswer;
  </script>
</body>
</html>
