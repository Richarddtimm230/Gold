<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Check Results | Gold and Linc Schools</title>
  <meta name="viewport" content="width=device-width, initial-scale=0.85">
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="check-results.css">
</head>
<body>
  <div class="results-root">
    <div class="results-header">
      <div class="results-title">Check Results</div>
      <div class="results-actions">
        <a href="student-dashboard.html"><i class="fa fa-arrow-left"></i> Dashboard</a>
      </div>
    </div>
    <main class="results-main">
      <!-- Search Section -->
      <section class="results-section">
        <div class="section-title"><i class="fa fa-search"></i> Check Your Result</div>
        <form class="result-search-form" id="resultSearchForm" autocomplete="off" onsubmit="return handleResultSearch(event)">
          <div class="result-form-group">
            <label class="result-form-label" for="userIdInput">User ID</label>
            <input id="userIdInput" class="result-form-input" placeholder="Enter User ID" required>
          </div>
          <div class="result-form-group">
            <label class="result-form-label" for="regNoInput">Registration Number</label>
            <input id="regNoInput" class="result-form-input" placeholder="Enter Registration Number" required>
          </div>
          <div class="result-form-group">
            <label class="result-form-label" for="classInput">Class</label>
            <select id="classInput" class="result-form-select" required>
              <option value="">Select Class</option>
              <option>Beginner</option>
              <option>KG1</option>
              <option>KG2</option>
              <option>Creche</option>
              <option>Nursery 1</option>
              <option>Nursery 2</option>
              <option>Nursery 3</option>
              <option>Primary 1</option>
              <option>Primary 2</option>
              <option>Primary 3</option>
              <option>Primary 4</option>
              <option>Primary 5</option>
              <option>Primary 6</option>
              <option>JSS1</option>
              <option>JSS2</option>
              <option>JSS3</option>
              <option>SS1</option>
              <option>SS2</option>
              <option>SS3</option>
            </select>
          </div>
          <div class="result-form-group">
            <label class="result-form-label" for="sessionInput">Session</label>
            <select id="sessionInput" class="result-form-select" required>
              <option value="">Select Session</option>
              <option>2024–2025</option>
              <option>2023–2024</option>
              <option>2022–2023</option>
            </select>
          </div>
          <div class="result-form-group">
            <label class="result-form-label" for="termInput">Term</label>
            <select id="termInput" class="result-form-select" required>
              <option value="">Select Term</option>
              <option>FIRST TERM</option>
              <option>SECOND TERM</option>
              <option>THIRD TERM</option>
            </select>
          </div>
          <button class="result-search-btn" type="submit"><i class="fa fa-search"></i> View Result</button>
        </form>
        <div class="result-search-error" id="searchError" style="display:none;"></div>
      </section>
      <!-- Results Display Section (hidden by default until search) -->
      <section class="results-section" id="resultsDisplaySection" style="display:none;">
        <div class="section-title"><i class="fa fa-table"></i> Result Details</div>
        <div style="margin-bottom:8px;display:flex;flex-wrap:wrap;gap:18px;">
          <span><b>User ID:</b> <span id="dispUserId"></span></span>
          <span><b>Reg. No:</b> <span id="dispRegNo"></span></span>
          <span><b>Class:</b> <span id="dispClass"></span></span>
          <span><b>Session:</b> <span id="dispSession"></span></span>
          <span><b>Term:</b> <span id="dispTerm"></span></span>
        </div>
        <div class="results-table-container">
          <table class="results-table" id="resultsTable">
            <thead>
              <tr>
                <th>Subject</th>
                <th>CA1</th>
                <th>CA2</th>
                <th>Midterm</th>
                <th>Exam</th>
                <th>Total</th>
                <th>Grade</th>
                <th>Remark</th>
              </tr>
            </thead>
            <tbody>
              <!-- JS fills rows -->
            </tbody>
          </table>
        </div>
        <button class="download-btn" onclick="downloadCurrentResult()"><i class="fa fa-download"></i> Download Result</button>
      </section>
      <!-- Previously Viewed Results -->
      <section class="results-section">
        <div class="section-title"><i class="fa fa-clock-rotate-left"></i> Previously Viewed Results</div>
        <div class="previous-results-list" id="previousResultsList"></div>
      </section>
      <!-- News Section -->
      <section class="news-section">
        <div class="news-title"><i class="fa fa-newspaper"></i> Result News & Announcements</div>
        <div class="news-list" id="newsList">
          <div class="news-item"><b>2024/2025 2nd Term Results Released!</b> Check your results now using your registration number.</div>
          <div class="news-item"><b>All 2023/2024 Results Archived</b> – You can still access them by searching with your details.</div>
          <div class="news-item"><b>New Online Scratch Card Sales</b> – Cards are now available at the school portal and accredited vendors.</div>
        </div>
      </section>
    </main>
    <nav class="bottom-nav">
      <button class="bottom-nav-btn" title="Home" onclick="window.location.href='dashboard.html'">
        <i class="fa fa-home"></i>
        <div class="bottom-nav-label">Home</div>
      </button>
      <button class="bottom-nav-btn" title="E-Class" onclick="window.location.href='e-class.html'">
        <i class="fa fa-laptop"></i>
        <div class="bottom-nav-label">E-Class</div>
      </button>
      <button class="bottom-nav-btn" title="Assignments" onclick="window.location.href='assignments.html'">
        <i class="fa fa-file-alt"></i>
        <div class="bottom-nav-label">Tasks</div>
      </button>
      <button class="bottom-nav-btn active" title="Results" onclick="window.location.href='results.html'">
        <i class="fa fa-chart-bar"></i>
        <div class="bottom-nav-label">Results</div>
      </button>
      <button class="bottom-nav-btn" title="Profile" onclick="window.location.href='profile.html'">
        <i class="fa fa-user"></i>
        <div class="bottom-nav-label">Me</div>
      </button>
    </nav>
    <script>
      const API_BASE_URL = "https://goldlincschools.onrender.com";

      let lastStudentProfile = null;
      let lastSkillsReport = null;
      let lastClassSize = null;

      // Remove autofillRegNo, allow manual entry

      function getViewedResults() {
        let arr = [];
        try { arr = JSON.parse(localStorage.getItem("viewedResults")) || []; } catch {}
        return arr;
      }
      function saveViewedResult(entry) {
        let arr = getViewedResults();
        arr = arr.filter(x => !(
          x.userId === entry.userId &&
          x.regNo === entry.regNo &&
          x.session === entry.session &&
          x.term === entry.term &&
          x.class === entry.class
        ));
        arr.unshift(entry);
        if (arr.length > 6) arr = arr.slice(0,6);
        localStorage.setItem("viewedResults", JSON.stringify(arr));
      }
      function renderPreviousResults() {
        const arr = getViewedResults();
        const el = document.getElementById("previousResultsList");
        if (!arr.length) {
          el.innerHTML = `<div style="color:#888;">No previously viewed results.</div>`;
          return;
        }
        el.innerHTML = arr.map((r,i) => `
          <div class="previous-result-card" onclick="viewPreviousResult(${i})">
            <div class="previous-result-title">${r.userId || r.regNo}</div>
            <div class="previous-result-meta">${r.class} • ${r.session} • ${r.term}</div>
          </div>
        `).join("");
      }
      function viewPreviousResult(idx) {
        const arr = getViewedResults();
        if (arr[idx]) displayResult(arr[idx]);
      }

      // Main: Handle result search using /api/results (fetch skills/attendance as well)
      async function handleResultSearch(e) {
        e.preventDefault();
        const userId = document.getElementById("userIdInput").value.trim();
        const regNo = document.getElementById("regNoInput").value.trim();
        const klass = document.getElementById("classInput").value;
        const session = document.getElementById("sessionInput").value;
        const term = document.getElementById("termInput").value;
        const errorBox = document.getElementById("searchError");
        errorBox.style.display = "none";

        if (!userId || !regNo || !klass || !session || !term) {
          errorBox.textContent = "All fields are required!";
          errorBox.style.display = "block";
          return false;
        }

        try {
          lastSkillsReport = null;
          lastClassSize = null;

          // Fetch results
          const params = new URLSearchParams({
            student_id: regNo, // or userId if API expects userId
            class: klass,
            session: session,
            term: term,
            status: "Published"
          });
          const response = await fetch(`${API_BASE_URL}/api/results?${params.toString()}`);
          const results = await response.json();
          if (!Array.isArray(results) || !results.length) {
            errorBox.textContent = "No result found! Please check your details or contact the school.";
            errorBox.style.display = "block";
            document.getElementById("resultsDisplaySection").style.display = "none";
            return false;
          }

          // Optionally add skills/class size logic here if needed

          // Save to previous results
          saveViewedResult({
            userId, regNo, class: klass, session, term, results: results,
            skillsReport: null, classSize: null,
            student: null
          });
          // Display
          displayResult({userId, regNo, class: klass, session, term, results: results, skillsReport: null, classSize: null, student: null});
          renderPreviousResults();
        } catch (err) {
          errorBox.textContent = err.message || "No result found! Please check your details or contact the school.";
          errorBox.style.display = "block";
          document.getElementById("resultsDisplaySection").style.display = "none";
        }
        return false;
      }

      // Display result in table and details (handles array response)
      function displayResult(r) {
        document.getElementById("resultsDisplaySection").style.display = "";
        document.getElementById("dispUserId").textContent = r.userId;
        document.getElementById("dispRegNo").textContent = r.regNo;
        document.getElementById("dispClass").textContent = r.class;
        document.getElementById("dispSession").textContent = r.session;
        document.getElementById("dispTerm").textContent = r.term;
        const tbody = document.getElementById("resultsTable").querySelector("tbody");
        tbody.innerHTML = r.results.map(res => `
          <tr>
            <td>${res.subject && res.subject.name ? res.subject.name : (res.subject_name || res.subject || "")}</td>
            <td>${res.ca1_score !== undefined ? res.ca1_score : ""}</td>
            <td>${res.ca2_score !== undefined ? res.ca2_score : ""}</td>
            <td>${res.midterm_score !== undefined ? res.midterm_score : ""}</td>
            <td>${res.exam_score !== undefined ? res.exam_score : ""}</td>
            <td>${res.total !== undefined ? res.total :
              (parseFloat(res.ca1_score || 0) + parseFloat(res.ca2_score || 0) + parseFloat(res.midterm_score || 0) + parseFloat(res.exam_score || 0))}</td>
            <td class="${res.grade === 'A' ? 'grade-high' : res.grade === 'D' ? 'grade-low' : 'grade-mid'}">${res.grade || ""}</td>
            <td>${res.remarks || res.remark || ""}</td>
          </tr>
        `).join("");
        window._lastDisplayedResult = r;
      }

      // Download result as report.html (populates sessionStorage and opens)
      function downloadCurrentResult() {
        const r = window._lastDisplayedResult;
        if (!r || !r.results || !r.results.length) {
          alert("No result to download. Please check a result first.");
          return;
        }
        // You may want to update this if you need userId or other fields in reportData
        sessionStorage.setItem("reportData", JSON.stringify(r));
        window.open('report.html', '_blank');
      }

      renderPreviousResults();
    </script>
  </div>
</body>
</html>
