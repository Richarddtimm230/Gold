<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gold and Linc Schools - Report Card</title>
  <link rel="stylesheet" href="report.css">
  <style>
    /* PRINT FULL WIDTH PATCH */
    @media print {
      html, body {
        width: 100%;
        height: 100%;
        margin: 0 !important;
        padding: 0 !important;
        background: #fff !important;
        box-shadow: none !important;
      }
      @page {
        size: A4 portrait;
        margin: 0;
      }
      .report-container {
        width: 100vw !important;
        min-width: 0 !important;
        max-width: 100vw !important;
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: none !important;
        background: #fff !important;
      }
      .results-table,
      .student-info-table,
      .grades-key-table,
      .skills-table,
      .attendance,
      .skills-tables-section {
        width: 100% !important;
        max-width: 100vw !important;
      }
      .no-print-btn {
        display: none !important;
      }
      section, .seal-container {
        margin-left: 0 !important;
        margin-right: 0 !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
      }
    }
    .report-container {
      width: 100vw;
      max-width: 100vw;
      margin: 0 auto;
      background: #fff;
    }
    .background-blur {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 60%;
      height: 60%;
      transform: translate(-50%, -50%);
      filter: blur(30px);
      opacity: 0.08;
      z-index: 0;
      pointer-events: none;
    }
    .seal-container {
      position: relative;
      display: flex;
      justify-content: center;
      margin-top: 40px;
    }
    .seal-container img {
      height: 80px;
      width: auto;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="report-container" id="reportCardDom">
    <img class="background-blur" src="logo-1679575828 (1).jpeg" alt="Blurred background">
    <button class="no-print-btn" onclick="downloadPDF()">Download as PDF</button>
    <header>
      <div class="school-header">
        <img src="logo-1679575828 (1).jpeg" alt="Golding Schools Logo" class="school-logo">
        <div class="school-info">
          <h1>GOLD AND LINC SCHOOLS</h1>
          <p>
            <span class="address">BEHIND IRENITEMI HOTEL, TESTING GROUND AREA, OFF OSOGBO ROAD, ILESA.</span><br>
            <span class="web">Website: goldlincschools.com</span>
            <span class="phone">Phone : 08034430941</span><br>
            <span class="email">Email : goldlincschool@gmail.com</span><br>
            <span class="motto">Motto : FOR A SOLID BEGINNING...</span>
          </p>
        </div>
        <img src="images (7).jpeg" alt="Nigeria Coat of Arms" class="coat-of-arms">
      </div>
      <div class="term-title">
        <h2 id="termTitle">FIRST TERM, 2024-2025 (END OF TERM REPORT)</h2>
      </div>
    </header>
    <section class="student-info-section">
      <table class="student-info-table" id="studentInfoTable">
        <tr>
          <td><strong>Name:</strong> <span id="stuName"></span></td>
          <td><strong>Performance Grade:</strong> <span id="perfGrade"></span></td>
        </tr>
        <tr>
          <td><strong>Reg. No:</strong> <span id="stuRegNo"></span></td>
          <td><strong>Class Size:</strong> <span id="classSize"></span></td>
        </tr>
        <tr>
          <td><strong>Gender:</strong> <span id="stuGender"></span></td>
          <td><strong>No. of Subjects:</strong> <span id="numSubjects"></span></td>
        </tr>
        <tr>
          <td><strong>Age:</strong> <span id="stuAge"></span></td>
          <td><strong>Student Total Score:</strong> <span id="stuTotalScore"></span></td>
        </tr>
        <tr>
          <td><strong>DOB:</strong> <span id="stuDOB"></span></td>
          <td><strong>Student Average (%):</strong> <span id="stuAverage"></span></td>
        </tr>
        <tr>
          <td><strong>Class:</strong> <span id="stuClass"></span></td>
          <td><strong>Grade Point Average:</strong> <span id="stuGPA"></span></td>
        </tr>
        <tr>
          <td><strong>Email:</strong> <span id="stuEmail"></span></td>
          <td><strong>Result Summary:</strong> <span id="resultSummary"></span></td>
        </tr>
      </table>
    </section>
    <section class="results-section">
      <table class="results-table" id="resultsTable">
        <thead>
          <tr>
            <th>Subject</th>
            <th>Continuous Assessment</th>
            <th>Mid Term Test</th>
            <th>Examination</th>
            <th>Total Score</th>
            <th>Score Grade</th>
            <th>Grade Remark</th>
            <th>Grade Points</th>
            <th>Teacher's Comment / Progress Report</th>
          </tr>
        </thead>
        <tbody>
          <!-- Populated by JS -->
        </tbody>
      </table>
    </section>
    <section class="skills-tables-section">
      <table class="skills-table affective-skills" id="affectiveSkillsTable">
        <thead>
          <tr>
            <th colspan="2">Affective Skills Rating (5)</th>
          </tr>
        </thead>
        <tbody>
          <!-- Populated by JS -->
        </tbody>
      </table>
      <table class="skills-table psychomotor-skills" id="psychomotorSkillsTable">
        <thead>
          <tr>
            <th colspan="2">Psychomotor Skills Rating (5)</th>
          </tr>
        </thead>
        <tbody>
          <!-- Populated by JS -->
        </tbody>
      </table>
      <table class="skills-table attendance" id="attendanceTable">
        <thead>
          <tr>
            <th colspan="2">Attendance Report</th>
          </tr>
        </thead>
        <tbody>
          <!-- Populated by JS -->
        </tbody>
      </table>
    </section>
    <section class="grades-key-section">
      <table class="grades-key-table">
        <tr>
          <th>Key to Grades</th>
          <td>70-100: <strong>A</strong></td>
          <td>60-69: <strong>B</strong></td>
          <td>50-59: <strong>C</strong></td>
          <td>45-49: <strong>D</strong></td>
          <td>40-44: <strong>E</strong></td>
          <td>0-39: <strong>F</strong></td>
        </tr>
        <tr>
          <td></td>
          <td>Excellent<br>5 Grade Points.</td>
          <td>Very Good<br>4 Grade Points.</td>
          <td>Good<br>3 Grade Points.</td>
          <td>Pass<br>2 Grade Points.</td>
          <td>Poor<br>1 Grade Point.</td>
          <td>Fail<br>0 Grade Points.</td>
        </tr>
      </table>
    </section>
    <section class="comments-section">
      <p class="principal-comment">
        <strong>Principal's Comment :</strong> <span id="principalComment"></span>
      </p>
      <div class="principal-sign">
        <span><strong>Principal:</strong> <span id="principalName"></span></span>
        <span><strong>Principal's Signature :</strong> ____________________</span>
      </div>
    </section>
    <section class="footer-section">
      <div class="next-term">
        <strong>Next Term Begins:</strong> <span class="next-term-date" id="nextTermDate"></span>
      </div>
      <div class="footer-meta">
        <span id="printDate"></span>
      </div>
    </section>
    <div class="seal-container">
      <img src="images (6).jpeg" alt="Red Seal" />
    </div>
  </div>
<script>
  function getFormattedPrintDate() {
    const now = new Date();
    const dd = now.getDate().toString().padStart(2,'0');
    const mm = (now.getMonth()+1).toString().padStart(2,'0');
    const yyyy = now.getFullYear();
    let h = now.getHours();
    let ampm = "am";
    if (h > 12) { h = h - 12; ampm = "pm"; }
    else if (h === 0) { h = 12; }
    const min = now.getMinutes().toString().padStart(2,'0');
    return `Printed : ${dd}-${mm}-${yyyy} ${h}:${min} ${ampm}`;
  }

  function formatDate(d) {
    if (!d) return "";
    // Accept 'YYYY-MM-DD', 'DD-MM-YYYY', 'DD/MM/YYYY', etc.
    let date;
    if (typeof d === "string") {
      const parts = d.split(/[-\/]/);
      if (parts.length === 3) {
        let year, month, day;
        if (parts[0].length === 4) {
          year = +parts[0]; month = +parts[1]; day = +parts[2];
        } else {
          day = +parts[0]; month = +parts[1]; year = +parts[2];
        }
        date = new Date(year, month - 1, day);
      } else {
        date = new Date(d);
      }
    } else {
      date = new Date(d);
    }
    if (!date || isNaN(date.getTime())) return d;
    return date.toLocaleDateString();
  }

  function calcAge(dobStr) {
    if (!dobStr) return "";
    let date;
    if (typeof dobStr === "string") {
      const parts = dobStr.split(/[-\/]/);
      if (parts.length === 3) {
        let year, month, day;
        if (parts[0].length === 4) {
          year = +parts[0]; month = +parts[1]; day = +parts[2];
        } else {
          day = +parts[0]; month = +parts[1]; year = +parts[2];
        }
        date = new Date(year, month-1, day);
      } else {
        date = new Date(dobStr);
      }
    } else {
      date = new Date(dobStr);
    }
    if (!date || isNaN(date.getTime())) return "";
    const now = new Date();
    let age = now.getFullYear() - date.getFullYear();
    if (now.getMonth() < date.getMonth() || (now.getMonth() === date.getMonth() && now.getDate() < date.getDate())) {
      age--;
    }
    return age;
  }

  function fillReport() {
    const dataStr = sessionStorage.getItem("reportData");
    if (!dataStr) return;
    const data = JSON.parse(dataStr);

    // Set term & session
    if (data.term && data.session) {
      document.getElementById("termTitle").innerText = `${data.term}, ${data.session} (END OF TERM REPORT)`;
    }

    // Student name & info
    if (data.student) {
      let name = "";
      if (data.student.firstname || data.student.surname || data.student.othernames) {
        name = [data.student.firstname, data.student.othernames, data.student.surname].filter(Boolean).join(" ");
      } else if (data.student.name) {
        name = data.student.name;
      }
      document.getElementById("stuName").innerText = name;
      document.getElementById("stuRegNo").innerText = data.student.regNo || data.regNo || "";
      document.getElementById("stuGender").innerText = data.student.gender || "";
      let dobVal = data.student.dob || data.student.DOB || "";
      document.getElementById("stuDOB").innerText = formatDate(dobVal);
      // Age calculation
      let ageVal = data.student.age || calcAge(dobVal);
      document.getElementById("stuAge").innerText = ageVal ? ageVal : "";
      // Email fallback
      document.getElementById("stuEmail").innerText = data.student.studentEmail || data.student.email || data.student.parentEmail || "";
      document.getElementById("stuClass").innerText = (data.class || "") + (data.student.classArm ? " - " + data.student.classArm : "");
    } else {
      document.getElementById("stuRegNo").innerText = data.regNo || "";
      document.getElementById("stuClass").innerText = data.class || "";
    }

    // Class size
    document.getElementById("classSize").innerText = data.classSize || "";

    // Number of subjects
    let numSubjects = Array.isArray(data.results) ? data.results.length : "";
    document.getElementById("numSubjects").innerText = numSubjects;

    // Principal's comment, name, next term date
    if (data.principalComment) document.getElementById("principalComment").innerText = data.principalComment;
    if (data.principalName) document.getElementById("principalName").innerText = data.principalName;
    if (data.nextTermDate) document.getElementById("nextTermDate").innerText = data.nextTermDate;

    // Results table
    const tbody = document.querySelector("#resultsTable tbody");
    let totalScore = 0;
    let totalGradePoints = 0;
    let subjectCount = 0;
    const maxPerSubject = 100;

    if (tbody && Array.isArray(data.results)) {
      tbody.innerHTML = data.results.map(res => {
        let subjectName = "";
        if (res.subject && typeof res.subject === "object" && res.subject.name) {
          subjectName = res.subject.name;
        } else if (typeof res.subject === "string") {
          subjectName = res.subject;
        } else if (res.subject_name) {
          subjectName = res.subject_name;
        }

        const ca1 = parseFloat(res.ca1_score || 0);
        const ca2 = parseFloat(res.ca2_score || 0);
        const mid = parseFloat(res.midterm_score || 0);
        const exam = parseFloat(res.exam_score || 0);
        const total = ca1 + ca2 + mid + exam;
        const gradePoint = parseFloat(res.grade_point || 0);
        totalScore += total;
        totalGradePoints += gradePoint;
        subjectCount++;

        return `
          <tr>
            <td>${subjectName}</td>
            <td>${ca1 + ca2}</td>
            <td>${mid}</td>
            <td>${exam}</td>
            <td>${res.total !== undefined ? res.total : total}</td>
            <td>${res.grade || ""}</td>
            <td>${res.remarks || res.remark || ""}</td>
            <td>${res.grade_point || ""}</td>
            <td>${res.teacher_comment || res.comment || ""}</td>
          </tr>
        `;
      }).join('');
    }

    const maxTotal = subjectCount * maxPerSubject;
    const avgScore = subjectCount > 0 ? (totalScore / subjectCount) : 0;
    const gpa = subjectCount > 0 ? (totalGradePoints / subjectCount) : 0;

    // Auto-grade based on average score
    let perfGrade = "";
    if (avgScore >= 70) perfGrade = "A (Excellent)";
    else if (avgScore >= 60) perfGrade = "B (Very Good)";
    else if (avgScore >= 50) perfGrade = "C (Good)";
    else if (avgScore >= 45) perfGrade = "D (Pass)";
    else if (avgScore >= 40) perfGrade = "E (Poor)";
    else perfGrade = "F (Fail)";

    // Auto-remark based on GPA
    let gpaRemark = "";
    if (gpa >= 4.5) gpaRemark = "Excellent";
    else if (gpa >= 3.5) gpaRemark = "Very Good";
    else if (gpa >= 2.5) gpaRemark = "Good";
    else if (gpa >= 1.5) gpaRemark = "Pass";
    else if (gpa > 0) gpaRemark = "Poor";
    else gpaRemark = "Fail";

    document.getElementById("stuTotalScore").innerText = `${totalScore} / ${maxTotal}`;
    document.getElementById("stuAverage").innerText = `${avgScore.toFixed(2)}%`;
    document.getElementById("stuGPA").innerText = gpa.toFixed(2);
    document.getElementById("perfGrade").innerText = perfGrade;
    document.getElementById("resultSummary").innerText = gpaRemark;

    // Fill skills tables if available
    if (data.affectiveSkills && Array.isArray(data.affectiveSkills)) {
      const rows = data.affectiveSkills.map(sk => `<tr><td>${sk.name}</td><td>${sk.score}</td></tr>`).join('');
      document.querySelector("#affectiveSkillsTable tbody").innerHTML = rows;
    }
    if (data.psychomotorSkills && Array.isArray(data.psychomotorSkills)) {
      const rows = data.psychomotorSkills.map(sk => `<tr><td>${sk.name}</td><td>${sk.score}</td></tr>`).join('');
      document.querySelector("#psychomotorSkillsTable tbody").innerHTML = rows;
    }
    // Attendance table with total and percentage
    if (data.attendance && Array.isArray(data.attendance)) {
      let totalDays = 0, presentDays = 0;
      let rows = data.attendance.map(a => {
        if (a.label && typeof a.value === "number") {
          if (a.label.toLowerCase().includes("present")) presentDays = a.value;
          if (a.label.toLowerCase().includes("total")) totalDays = a.value;
        }
        return `<tr><td>${a.label}</td><td>${a.value}</td></tr>`;
      }).join('');
      // If attendance array consists of objects like {present, total}
      if ((!totalDays || !presentDays) && data.attendance.length && typeof data.attendance[0] === "object") {
        const att = data.attendance[0];
        presentDays = att.present || presentDays;
        totalDays = att.total || totalDays;
      }
      if (totalDays) rows += `<tr><td><b>Total Days</b></td><td>${totalDays}</td></tr>`;
      if (presentDays && totalDays) {
        const pct = ((presentDays / totalDays) * 100).toFixed(2);
        rows += `<tr><td><b>Attendance (%)</b></td><td>${pct}%</td></tr>`;
      }
      document.querySelector("#attendanceTable tbody").innerHTML = rows;
    }

    document.getElementById("printDate").innerText = getFormattedPrintDate();
  }

  window.addEventListener('DOMContentLoaded', fillReport);

  async function downloadPDF() {
    const reportDom = document.getElementById('reportCardDom');
    document.querySelector('.no-print-btn').style.visibility = 'hidden';
    await new Promise(r => setTimeout(r, 250));
    html2canvas(reportDom, {scale:2, useCORS:true, backgroundColor: "#fff"}).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const pdf = new window.jspdf.jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: [297, 210]
      });
      const pageWidth = 210;
      const pageHeight = 297;
      const imgOriginalWidth = canvas.width;
      const imgOriginalHeight = canvas.height;
      const scale = Math.min(pageWidth / imgOriginalWidth, pageHeight / imgOriginalHeight);
      const imgWidth = imgOriginalWidth * scale;
      const imgHeight = imgOriginalHeight * scale;
      const xOffset = (pageWidth - imgWidth) / 2;
      const yOffset = (pageHeight - imgHeight) / 2;
      pdf.addImage(imgData, 'PNG', xOffset, yOffset, imgWidth, imgHeight);
      pdf.save('ReportCard.pdf');
      document.querySelector('.no-print-btn').style.visibility = 'visible';
    }).catch(e=>{
      alert("Could not generate PDF: " + e.message);
      document.querySelector('.no-print-btn').style.visibility = 'visible';
    });
  }
</script>
</body>
</html>
