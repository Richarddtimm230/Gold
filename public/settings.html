<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Homepage Editor – Gold and Linc Schools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts for elegance -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="icon" href="https://goldlincschools.com/assets/media/logos/favicon.ico">
  <style>
    :root {
      --primary: #217353;
      --secondary: #0e4a30;
      --accent: #f6b10a;
      --bg: #f6f8f6;
      --card: #fff;
      --radius: 13px;
      --shadow: 0 3px 16px 0 rgba(33,115,83,0.07);
      --text-main: #133e27;
      --text-muted: #666;
      --gradient: linear-gradient(90deg, #217353 0%, #0e4a30 100%);
      --danger: #e74c3c;
      --success: #27ae60;
    }
    * { box-sizing: border-box; }
    html,body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      font-family: 'Inter', Arial, sans-serif;
      color: var(--text-main);
      min-height: 100vh;
      scroll-behavior: smooth;
    }
    /* HEADER */
    .editor-header {
      background: var(--gradient);
      color: #fff;
      padding: 0;
      text-align: center;
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      border-bottom: 3px solid #f6b10a22;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      min-height: 68px;
      box-shadow: 0 2px 10px #1a623a12;
    }
    .editor-header .school-logo {
      display: flex;
      align-items: center;
      gap: 13px;
      margin-left: 2vw;
    }
    .editor-header .school-logo img {
      width: 52px; height: 60px;
      border-radius: 12px;
      box-shadow: 0 2px 8px #00000022;
      background: #fff;
      object-fit: cover;
      border: 2px solid #fff;
    }
    .editor-header .school-name {
      font-family: 'Playfair Display', serif;
      font-size: 1.35rem;
      color: #fff;
      letter-spacing: 1.5px;
      font-weight: 800;
      text-shadow: 0 1px 5px #0e3b1f66;
      margin-left: 12px;
    }
    .editor-header .logout-btn {
      margin-right: 2vw;
      background: var(--danger);
      color: #fff;
      border: none;
      padding: 8px 19px;
      border-radius: 7px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 1px 4px #1a623a11;
      transition: background .15s;
    }
    .editor-header .logout-btn:hover {
      background: #c0392b;
    }
    /* MAIN CONTAINER */
    .editor-main {
      max-width: 980px;
      background: var(--card);
      margin: 36px auto 32px auto;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 36px 24px 28px 24px;
      animation: fadein 0.9s;
      min-height: 70vh;
    }
    @keyframes fadein { from { opacity:0; transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }
    .editor-main h2 {
      font-family: 'Playfair Display', serif;
      color: var(--primary);
      font-size: 2rem;
      margin-bottom: 30px;
      text-align: center;
      font-weight: 700;
      letter-spacing: .03em;
    }
    .section-title {
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--secondary);
      margin-top: 22px;
      margin-bottom: 9px;
      letter-spacing: .02em;
      border-left: 3.5px solid var(--accent);
      padding-left: 11px;
    }
    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 18px;
      align-items: flex-end;
    }
    .input-col {
      flex: 1 1 210px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    label {
      font-weight: 600;
      color: var(--text-main);
      font-size: 0.98rem;
      margin-bottom: 3px;
    }
    input[type="text"], textarea {
      font: inherit;
      border: 1.5px solid #c4dfcd;
      border-radius: 7px;
      padding: 9px 10px;
      font-size: 1rem;
      background: #f7faf7;
      color: var(--text-main);
      margin-bottom: 5px;
      transition: border .13s;
    }
    input[type="text"]:focus, textarea:focus {
      border: 1.5px solid var(--primary);
      outline: none;
      background: #fff;
    }
    textarea {
      min-height: 65px;
      resize: vertical;
    }
    .hero-images-uploader {
      margin-bottom: 16px;
    }
    .hero-images-list {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin: 6px 0 7px 0;
    }
    .hero-image-thumb {
      position: relative;
      width: 120px; height: 74px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 8px #21735333;
      background: #f0f3e6;
      border: 1.5px solid #e3f0ea;
    }
    .hero-image-thumb img {
      width: 100%; height: 100%; object-fit: cover;
      display: block;
    }
    .remove-hero-img-btn {
      position: absolute;
      top: 4px; right: 4px;
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 23px; height: 23px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      font-size: 1.02rem;
      box-shadow: 0 1px 6px #0002;
      opacity: 0.8;
      transition: opacity .12s;
    }
    .remove-hero-img-btn:hover {
      opacity: 1;
      background: #b9321a;
    }
    .add-img-url-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 9px;
    }
    .add-img-url-row input {
      flex: 1 1 200px;
    }
    .add-img-url-btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 7px 13px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.97rem;
      transition: background .13s;
    }
    .add-img-url-btn:hover {
      background: var(--accent);
      color: var(--primary);
    }
    .section-divider {
      margin: 32px 0 18px 0;
      border-top: 1.5px solid #e7efe7;
    }
    .editor-actions {
      display: flex;
      gap: 16px;
      margin-top: 18px;
      justify-content: flex-end;
      align-items: center;
    }
    .save-btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 11px 28px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1.09rem;
      cursor: pointer;
      transition: background .17s;
      box-shadow: 0 2px 8px #21735322;
    }
    .save-btn[disabled] {
      opacity: 0.7;
      cursor: not-allowed;
    }
    .save-btn:hover:not([disabled]) {
      background: var(--accent);
      color: var(--primary);
    }
    .reset-btn {
      background: #eaeaea;
      color: #333;
      border: none;
      padding: 11px 21px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.01rem;
      cursor: pointer;
      transition: background .13s;
    }
    .reset-btn:hover { background: #f4f4f4; }
    .editor-msg {
      margin-left: 17px;
      font-weight: 500;
      font-size: 1.02rem;
      min-width: 120px;
    }
    .editor-msg.success { color: var(--success);}
    .editor-msg.error { color: var(--danger);}
    .loading-indicator {
      display: inline-block;
      width: 23px; height: 23px;
      border: 3px solid #c4dfcd;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
      margin-left: 7px;
      vertical-align: middle;
    }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    /* Responsive */
    @media (max-width: 900px) {
      .editor-main { padding: 18px 7vw 18px 7vw;}
    }
    @media (max-width: 600px) {
      .editor-main { padding: 6vw 2vw 6vw 2vw;}
      .editor-header .school-logo img { width: 35px; height: 39px;}
      .editor-header .school-name { font-size: 1.07rem;}
    }
    /* File input visually hidden */
    .file-input {
      display: none;
    }
    .file-label {
      background: var(--primary);
      color: #fff;
      border-radius: 7px;
      padding: 7px 21px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.98rem;
      transition: background .15s;
      margin-top: 5px;
      margin-bottom: 8px;
      display: inline-block;
    }
    .file-label:hover {
      background: var(--accent);
      color: var(--primary);
    }
    /* Preview for About/Section text */
    .preview-block {
      background: #f8fefb;
      border-radius: 9px;
      box-shadow: 0 2px 8px #0001;
      padding: 12px 15px;
      margin: 4px 0 0 0;
      color: #282828;
      font-size: 1.03rem;
      font-family: inherit;
      min-height: 37px;
      border: 1px solid #e7efe7;
    }
    .preview-label {
      font-size: 0.97rem;
      color: var(--text-muted);
      font-style: italic;
      margin-bottom: 0px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <header class="editor-header">
    <div class="school-logo">
      <img src="https://goldlincschools.com/assets/media/logos/favicon.ico" alt="Logo">
      <span class="school-name">Gold and Linc Schools – Homepage Editor</span>
    </div>
    <button class="logout-btn" id="logoutBtn" title="Log out">Logout</button>
  </header>
  <main class="editor-main">
    <h2>Homepage Editor</h2>
    <form id="homepageEditorForm" autocomplete="off">
      <!-- HERO SECTION -->
      <div class="section-title">Hero Section</div>
      <div class="input-row">
        <div class="input-col">
          <label for="heroTitle">Title</label>
          <input type="text" id="heroTitle" name="heroTitle" maxlength="60" required>
        </div>
        <div class="input-col">
          <label for="heroSubtitle">Subtitle</label>
          <input type="text" id="heroSubtitle" name="heroSubtitle" maxlength="90">
        </div>
        <div class="input-col">
          <label for="heroMotto">Motto</label>
          <input type="text" id="heroMotto" name="heroMotto" maxlength="90">
        </div>
      </div>
      <div class="hero-images-uploader">
        <label><b>Hero Images (multiple):</b>
          <span class="file-label" id="uploadHeroImgBtn">Upload Images</span>
          <input type="file" class="file-input" id="heroImgFileInput" accept="image/*" multiple>
        </label>
        <div class="add-img-url-row">
          <input type="text" id="newHeroImgUrl" placeholder="Paste image URL...">
          <button type="button" class="add-img-url-btn" id="addHeroImgUrlBtn">Add Image URL</button>
        </div>
        <div class="hero-images-list" id="heroImagesList"></div>
      </div>
      <!-- ABOUT SECTION -->
      <div class="section-divider"></div>
      <div class="section-title">About Section</div>
      <textarea id="aboutSection" name="aboutSection" maxlength="800" placeholder="About the school..." style="margin-bottom:5px;"></textarea>
      <div class="preview-label">Preview:</div>
      <div class="preview-block" id="aboutSectionPreview"></div>
      <!-- Other sections can be added here in similar fashion -->
      <div class="editor-actions">
        <button type="reset" class="reset-btn">Reset</button>
        <button type="submit" class="save-btn" id="saveBtn">Save Changes</button>
        <span class="editor-msg" id="editorMsg"></span>
        <span class="loading-indicator" id="loadingIndicator" style="display:none"></span>
      </div>
    </form>
  </main>
  <script>
    // Define your backend API base URL here
    // This makes it easy to change if your backend URL changes (e.g., moving from Render's default URL to a custom domain)
    const API_BASE_URL = 'https://goldlincschools.onrender.com'; // <--- THIS IS THE KEY CHANGE

    // ========== AUTH & REDIRECT ==========
    (function(){
      const token = localStorage.getItem('token');
      if (!token) return window.location.href = 'login.html';
      fetch(`${API_BASE_URL}/api/auth/me`, { // Use API_BASE_URL
        headers: { 'Authorization': `Bearer ${token}` }
      }).then(res => {
        if (!res.ok) return window.location.href = 'login.html';
        return res.json();
      }).then(user => {
        if (!user || user.role !== "superadmin") window.location.href = 'login.html';
      }).catch(() => window.location.href = 'login.html');
    })();

    // ========== LOGOUT ==========
    document.getElementById('logoutBtn').onclick = function() {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    };

    // ========== STATE ==========
    let heroImages = []; // {src, file?, uploaded?}
    let heroImagesToDelete = [];

    // ========== DOM ==========
    const heroImagesListDiv = document.getElementById('heroImagesList');
    const heroImgFileInput = document.getElementById('heroImgFileInput');
    const uploadHeroImgBtn = document.getElementById('uploadHeroImgBtn');
    const addHeroImgUrlBtn = document.getElementById('addHeroImgUrlBtn');
    const newHeroImgUrlInput = document.getElementById('newHeroImgUrl');
    const aboutSectionTextarea = document.getElementById('aboutSection');
    const aboutSectionPreview = document.getElementById('aboutSectionPreview');
    const homepageEditorForm = document.getElementById('homepageEditorForm');
    const editorMsg = document.getElementById('editorMsg');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const saveBtn = document.getElementById('saveBtn');

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', loadHomepageContent);

    // ========== HERO IMAGE MANAGEMENT ==========
    uploadHeroImgBtn.onclick = function() { heroImgFileInput.click(); };
    heroImgFileInput.onchange = function(e) {
      Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(ev) {
          heroImages.push({src: ev.target.result, file, uploaded: false});
          renderHeroImagesList();
        };
        reader.readAsDataURL(file);
      });
      heroImgFileInput.value = "";
    };
    addHeroImgUrlBtn.onclick = function() {
      const url = newHeroImgUrlInput.value.trim();
      if (!url) return;
      heroImages.push({src: url, uploaded: true});
      newHeroImgUrlInput.value = "";
      renderHeroImagesList();
    };
    function removeHeroImg(idx) {
      const img = heroImages[idx];
      if (img.uploaded && img.src) heroImagesToDelete.push(img.src);
      heroImages.splice(idx,1);
      renderHeroImagesList();
    }
    function renderHeroImagesList() {
      heroImagesListDiv.innerHTML = "";
      if (!heroImages.length) {
        heroImagesListDiv.innerHTML = `<span style="color:#888;">No images yet.</span>`;
      } else {
        heroImages.forEach((img,i) => {
          const div = document.createElement('div');
          div.className = 'hero-image-thumb';
          div.innerHTML = `<img src="${img.src}" loading="lazy" alt="Hero Image"><button type="button" class="remove-hero-img-btn" title="Remove" onclick="removeHeroImg(${i})">&times;</button>`;
          heroImagesListDiv.appendChild(div);
        });
      }
    }
    // Make function global for onclick in renderHeroImagesList
    window.removeHeroImg = removeHeroImg;

    // ========== ABOUT SECTION PREVIEW ==========
    aboutSectionTextarea.addEventListener('input', function() {
      aboutSectionPreview.textContent = aboutSectionTextarea.value || "—";
    });

    // ========== LOAD HOMEPAGE CONTENT ==========
    async function loadHomepageContent() {
      setLoading(true, "Loading homepage...");
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API_BASE_URL}/api/admin/homepage`, { // Use API_BASE_URL
          headers: {'Authorization': `Bearer ${token}`}
        });
        if (!res.ok) throw new Error("Failed to load homepage details");
        const data = await res.json();
        document.getElementById('heroTitle').value = data.heroTitle || "";
        document.getElementById('heroSubtitle').value = data.heroSubtitle || "";
        document.getElementById('heroMotto').value = data.heroMotto || "";
        heroImages = Array.isArray(data.heroImages)
          ? data.heroImages.map(url => ({src: url, uploaded: true}))
          : (data.heroImages ? [{src: data.heroImages, uploaded: true}] : []);
        renderHeroImagesList();
        aboutSectionTextarea.value = data.aboutSection || "";
        aboutSectionPreview.textContent = data.aboutSection || "—";
        setMsg("", "");
      } catch (e) {
        setMsg("❌ Could not load homepage content.", "error");
      } finally {
        setLoading(false);
      }
    }

    // ========== UPLOAD HERO IMAGES ==========
    async function uploadNewImages() {
      // Only upload ones with file && uploaded==false
      const toUpload = heroImages.filter(img => img.file && !img.uploaded);
      if (!toUpload.length) return [];
      const token = localStorage.getItem('token');
      const urls = [];
      for (const img of toUpload) {
        const formData = new FormData();
        formData.append('file', img.file);
        const res = await fetch(`${API_BASE_URL}/api/admin/upload-image`, { // Use API_BASE_URL
          method: 'POST',
          headers: {'Authorization': `Bearer ${token}`},
          body: formData
        });
        if (!res.ok) throw new Error("Image upload failed");
        const { url } = await res.json();
        urls.push(url);
        img.src = url;
        img.uploaded = true;
        delete img.file;
      }
      return urls;
    }

    // ========== SAVE HOMEPAGE ==========
    homepageEditorForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      setMsg("", "");
      setLoading(true, "Saving...");
      saveBtn.disabled = true;
      try {
        // 1. Upload new hero images (if any)
        await uploadNewImages();
        // 2. Prepare heroImages URLs only
        const heroImagesUrls = heroImages.map(img => img.src);
        // 3. Prepare payload
        const payload = {
          heroTitle: document.getElementById('heroTitle').value,
          heroSubtitle: document.getElementById('heroSubtitle').value,
          heroMotto: document.getElementById('heroMotto').value,
          heroImages: heroImagesUrls,
          aboutSection: document.getElementById('aboutSection').value,
        };
        // 4. Update homepage content
        const token = localStorage.getItem('token');
        const res = await fetch(`${API_BASE_URL}/api/admin/homepage`, { // Use API_BASE_URL
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("Failed to update homepage");
        setMsg("✔️ Homepage updated!", "success");
        // 5. Optionally: delete removed images from server (not implemented, but backend can do garbage collection)
      } catch (e) {
        setMsg("❌ Update failed. " + (e.message || ""), "error");
      } finally {
        setLoading(false);
        saveBtn.disabled = false;
      }
    });

    // ========== RESET FORM ==========
    homepageEditorForm.addEventListener('reset', function(){
      setTimeout(loadHomepageContent, 50);
    });

    // ========== UTILS ==========
    function setMsg(msg, type) {
      editorMsg.textContent = msg;
      editorMsg.className = "editor-msg" + (type ? " "+type : "");
    }
    function setLoading(state, msg) {
      if (state) {
        loadingIndicator.style.display = "";
        if (msg) setMsg(msg, "");
        saveBtn.disabled = true;
      } else {
        loadingIndicator.style.display = "none";
        saveBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
