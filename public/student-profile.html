<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Profile | Gold and Linc Schools</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="students-view.css">
  
</head>
<body>
    <div id="profileSpinnerOverlay"><div class="spinner"></div></div>
    <div class="profile-container" id="profile-container">
        <div class="profile-header">
            <img id="student-avatar" class="profile-avatar" src="" alt="Student Avatar">
            <div>
                <h2 id="student-name"></h2>
                <div id="student-reg"></div>
            </div>
        </div>
        <table class="profile-detail-table" id="profile-table"></table>
        <div class="profile-actions">
            <button class="btn-edit" id="editBtn">Edit</button>
            <button class="btn-skills" id="skillsBtn">Fill Skills & Reports</button>
        </div>
    </div>
    <!-- Modal for Skills & Reports -->
    <div class="modal" id="skillsModal">
        <div class="modal-content">
            <span class="close-modal" id="closeSkillsModal">&times;</span>
            <h3>Fill Skills & Other Reports</h3>
            <form id="skillsForm" autocomplete="off">
                <label>Affective Skills (1-5)</label>
                <table class="skills-section-table">
                  <tr>
                     <td>Punctuality</td>
                     <td><input type="number" name="affective_punctuality" min="1" max="5" required></td>
                  </tr>
                  <tr>
                     <td>Attentiveness</td>
                     <td><input type="number" name="affective_attentiveness" min="1" max="5" required></td>
                  </tr>
                  <tr>
                     <td>Neatness</td>
                     <td><input type="number" name="affective_neatness" min="1" max="5" required></td>
                  </tr>
                  <tr>
                     <td>Honesty</td>
                     <td><input type="number" name="affective_honesty" min="1" max="5" required></td>
                  </tr>
                  <tr>
                     <td>Politeness</td>
                     <td><input type="number" name="affective_politeness" min="1" max="5" required></td>
                  </tr>
                </table>
                <label>Psychomotor Skills (1-5)</label>
                <table class="skills-section-table">
                  <tr>
                    <td>Hand Writing</td>
                    <td><input type="number" name="psycho_handwriting" min="1" max="5" required></td>
                  </tr>
                  <tr>
                    <td>Drawing and Painting</td>
                    <td><input type="number" name="psycho_drawing" min="1" max="5" required></td>
                  </tr>
                  <tr>
                    <td>Sports and Games</td>
                    <td><input type="number" name="psycho_sports" min="1" max="5" required></td>
                  </tr>
                  <tr>
                    <td>Organization Ability</td>
                    <td><input type="number" name="psycho_organization" min="1" max="5" required></td>
                  </tr>
                </table>
                <label>Attendance Report</label>
                <input type="number" name="attendance_days_present" placeholder="Days Present" required>
                <input type="number" name="attendance_days_absent" placeholder="Days Absent" required>
                <label>Principal's Comment</label>
                <textarea name="principal_comment" maxlength="200" required></textarea>
                <button type="submit" class="btn-submit">Save Skills & Report</button>
                <div id="skillsStatus" style="color:#20c997;margin-top:0.6em;"></div>
            </form>
        </div>
    </div>
    <!-- Modal for Editing Student -->
    <div class="modal" id="editStudentModal">
        <div class="modal-content">
            <span class="close-modal" id="closeEditModal">&times;</span>
            <h3>Edit Student Profile</h3>
            <form id="editStudentForm" autocomplete="off">
                <div id="editModalSpinner"><div class="spinner" style="width:30px;height:30px;border-width:4px;"></div></div>
                <div id="editFieldsWrapper"></div>
                <button type="submit" class="btn-submit">Save Changes</button>
            </form>
        </div>
    </div>
<script>
// Extracted JS-only changes for quick preview
const API_BASE_URL = "https://goldlincschools.onrender.com";
const studentIdParam = new URL(window.location.href).searchParams.get('student_id');
let loadedStudent = null;

function showSpinner(show) {
  const el = document.getElementById('profileSpinnerOverlay');
  if (el) el.style.display = show ? 'flex' : 'none';
}

async function fetchAndRenderStudent() {
  showSpinner(true);
  const profileContainer = document.getElementById('profile-container');
  if (!studentIdParam) {
    showSpinner(false);
    profileContainer.innerHTML = "<p style='color:#dc3545;'>No student selected.</p>";
    return;
  }
  try {
    let url = `${API_BASE_URL}/api/students?student_id=${encodeURIComponent(studentIdParam)}`;
    let res = await fetch(url);
    let data = await res.json();
    let stu = (Array.isArray(data.students) && data.students.length > 0) ? data.students[0] : null;

    if (!stu) {
      url = `${API_BASE_URL}/api/students?regNo=${encodeURIComponent(studentIdParam)}`;
      res = await fetch(url);
      data = await res.json();
      stu = (Array.isArray(data.students) && data.students.length > 0) ? data.students[0] : null;
    }

    if (!stu) {
      profileContainer.innerHTML = "<p style='color:#dc3545;'>Student not found.</p>";
      return;
    }

    loadedStudent = stu;
    document.getElementById('student-avatar').src = stu.photoBase64 || stu.photo || 'https://cdn-icons-png.flaticon.com/512/3135/3135768.png';
    document.getElementById('student-name').textContent = `${stu.firstname || ''} ${stu.surname || ''}`.trim();
    document.getElementById('student-reg').textContent = 'Reg No: ' + (stu.regNo || stu.student_id || studentIdParam);

    const detailFields = [
      {label: "Class", value: stu.class?.name || stu.class || ''},
      {label: "Class Arm", value: stu.classArm || ''},
      {label: "Scratch Card", value: stu.scratchCard || ''},
      {label: "Date of Birth", value: stu.dob ? new Date(stu.dob).toLocaleDateString() : ''},
      {label: "Gender", value: stu.gender || ''},
      {label: "Parent Name", value: stu.parentName || ''},
      {label: "Parent Relationship", value: stu.parentRelationship || ''},
      {label: "Parent Phone", value: stu.parentPhone || ''},
      {label: "Parent Email", value: stu.parentEmail || ''},
      {label: "Parent Address", value: stu.parentAddress || ''},
      {label: "Parent Occupation", value: stu.parentOccupation || ''},
      {label: "Student Email", value: stu.studentEmail || ''},
      {label: "Student Phone", value: stu.studentPhone || ''},
      {label: "Address", value: stu.address || ''},
      {label: "Nationality", value: stu.nationality || ''},
      {label: "State", value: stu.state || ''},
      {label: "LGA", value: stu.lga || ''},
      {label: "Previous School", value: stu.previousSchool || ''},
      {label: "Admission Date", value: stu.admissionDate ? new Date(stu.admissionDate).toLocaleDateString() : ''},
      {label: "Academic Session", value: stu.academicSession || ''},
    ];
    const table = document.getElementById('profile-table');
    table.innerHTML = detailFields.map(f => `<tr><td><b>${f.label}</b></td><td>${f.value}</td></tr>`).join('');
  } catch (err) {
    profileContainer.innerHTML = "<p style='color:#dc3545;'>Failed to load student.</p>";
  } finally {
    showSpinner(false);
  }
}

fetchAndRenderStudent();

// Skills form without token header
const form = document.getElementById('skillsForm');
form.onsubmit = async function(e){
  e.preventDefault();
  if (!loadedStudent || !loadedStudent.regNo) {
    document.getElementById('skillsStatus').textContent = "❌ Student not loaded!";
    return;
  }

  const payload = {
    session: "2024-2025",
    term: "First Term",
    skills: {
      affective: {
        punctuality: form.affective_punctuality.value,
        attentiveness: form.affective_attentiveness.value,
        neatness: form.affective_neatness.value,
        honesty: form.affective_honesty.value,
        politeness: form.affective_politeness.value,
      },
      psychomotor: {
        handwriting: form.psycho_handwriting.value,
        drawing: form.psycho_drawing.value,
        sports: form.psycho_sports.value,
        organization: form.psycho_organization.value,
      },
    },
    attendance: {
      days_present: form.attendance_days_present.value,
      days_absent: form.attendance_days_absent.value,
    },
    comment: form.principal_comment.value,
  };

  const studentIdentifier = encodeURIComponent(loadedStudent.student_id || loadedStudent.regNo);

  document.getElementById('skillsStatus').textContent = "Saving...";

  try {
    const res = await fetch(`${API_BASE_URL}/api/students/${studentIdentifier}/skills-report`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
        // No Authorization
      },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (res.ok) {
      document.getElementById('skillsStatus').textContent = "✔️ Skills and report saved!";
      setTimeout(() => {
        document.getElementById('skillsModal').classList.remove('active');
      }, 1000);
    } else {
      document.getElementById('skillsStatus').textContent = "❌ " + (data.error || "Failed to save.");
    }
  } catch (err) {
    document.getElementById('skillsStatus').textContent = "❌ Failed to save.";
  }
};
</script>
</body>
</html>
