<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Staff Management | School Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html,body{margin:0;padding:0;background:#f7fafc;font-family:"Segoe UI",Arial,sans-serif;}
    .enroll-container{
      max-width: 950px; margin: 40px auto 30px auto; background:#fff; border-radius:10px;
      box-shadow:0 3px 18px rgba(0,0,0,0.06); padding:32px 18px 24px 18px;
    }
    h2{margin-top:0;text-align:center;color:#007bff;}
    .form-tabs{display:flex;gap:3px;margin-bottom:25px;}
    .form-tab{
      flex:1;background:#f1f3f7;border:none;
      padding:11px 2px;font-weight:500;font-size:16px;
      color:#222;border-radius:8px 8px 0 0;
      cursor:pointer;transition:background .11s;
      border-bottom:2.5px solid transparent;
    }
    .form-tab.active{background:#fff;color:#007bff;border-bottom:2.5px solid #007bff;}
    .form-section{display:none;}
    .form-section.active{display:block;}
    .form-row{display:flex;gap:17px;}
    .form-group{flex:1 1 0;display:flex;flex-direction:column;margin-bottom:18px;}
    .form-group label{font-weight:500;margin-bottom:4px;}
    .form-group input[type="text"],.form-group input[type="email"],.form-group input[type="date"],.form-group input[type="password"],.form-group input[type="tel"],.form-group select{
      padding:8px 10px;border-radius:6px;border:1px solid #d9dee3;font-size:15px;background:#f8fafc;}
    .form-group textarea{
      padding:8px 10px;border-radius:6px;border:1px solid #d9dee3;font-size:15px;min-height:44px;background:#f8fafc;}
    .form-group input[type="file"]{padding:3px 0;}
    .photo-uploader{display:flex;flex-direction:column;align-items:center;margin-bottom:12px;}
    .photo-box{
      width:90px;height:90px;border-radius:10px;overflow:hidden;background:#f8fafc;
      border:2px dashed #bfbfbf;display:flex;align-items:center;justify-content:center;margin-bottom:4px;
    }
    .photo-box img{width:86px;height:86px;object-fit:cover;border-radius:8px;}
    .photo-placeholder{color:#bbb;font-size:39px;}
    button[type=submit],.form-actions button{
      background:#007bff;color:#fff;border:none;border-radius:6px;padding:10px 32px;font-size:16px;font-weight:600;cursor:pointer;transition:background .13s;}
    button[type=submit]:hover,.form-actions button:hover{background:#0056b3;}
    .form-actions{text-align:right;margin-top:9px;}
    @media (max-width:700px){
      .form-row{flex-direction:column;gap:0;}
      .enroll-container {padding:18px 2vw 18px 2vw;}
    }
    .note{font-size:14px;color:#888;margin-bottom:9px;}
    /* Staff List */
    .staff-list-section{padding:0 10px 10px 10px;}
    .staff-list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
    .staff-search{padding:6px 12px;border-radius:5px;border:1px solid #d9dee3;font-size:15px;width:240px;}
    .staff-table{width:100%;border-collapse:collapse;}
    .staff-table th,.staff-table td{padding:8px 6px;text-align:left;}
    .staff-table th{background:#f1f3f7;}
    .staff-table tr{transition:background .08s;}
    .staff-table tr:hover{background:#f0f6ff;cursor:pointer;}
    .staff-avatar{width:38px;height:38px;border-radius:6px;object-fit:cover;background:#f4f4f4;}
    /* Modal */
    .modal-overlay{
      display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999;
      background:rgba(0,0,0,0.27);align-items:center;justify-content:center;
    }
    .modal-overlay.active{display:flex;}
    .modal-content{
      background:#fff;border-radius:10px;box-shadow:0 5px 32px rgba(0,0,0,0.17);
      padding:26px 30px 18px 30px;max-width:480px;width:96vw;max-height:94vh;overflow-y:auto;position:relative;
      animation:popIn .21s cubic-bezier(.3,1.7,.7,.7);
    }
    @keyframes popIn{from{transform:scale(.95);opacity:.2;}to{transform:scale(1);opacity:1;}}
    .modal-close{position:absolute;top:12px;right:16px;font-size:22px;color:#888;cursor:pointer;}
    .modal-photo{width:90px;height:90px;border-radius:11px;object-fit:cover;background:#f8fafc;margin-bottom:10px;}
    .modal-details{margin-bottom:6px;}
    .modal-details label{display:block;font-weight:600;margin-bottom:1px;}
    .modal-details span{display:block;margin-bottom:5px;}
    .modal-title{font-size:22px;font-weight:700;color:#007bff;margin-bottom:4px;}
    .modal-section{margin-bottom:13px;}
    .modal-section-title{font-size:15px;font-weight:600;color:#555;margin-bottom:2px;}
    .empty-staff-list{color:#888;text-align:center;padding:30px;font-size:15px;}
  </style>
</head>
<body>
<div class="enroll-container">
  <h2>Staff Management</h2>
  <div class="form-tabs">
    <button class="form-tab active" data-tab="enroll">Enroll Staff</button>
    <button class="form-tab" data-tab="view">View Staff</button>
  </div>
  <!-- Enroll Staff Section -->
  <div class="form-section active" id="tab-enroll">
    <form id="staffEnrollForm" enctype="multipart/form-data" autocomplete="off">
      <!-- ... (keep your existing enrollment form here, unchanged) ... -->
      <!-- (For brevity, not repeating the form markup, copy from your existing teachers.html) -->
      <!-- >>>>> COPY THE FULL FORM FROM THE ORIGINAL teachers.html HERE <<<<< -->
      <!-- ... -->
      <!-- Paste the entire enrollment form markup here, unchanged ... -->
      <!-- ... (end of enrollment form) ... -->
      <!-- Start of original form content -->
      <div class="form-row">
        <div class="form-group" style="max-width:140px;align-items:center;">
          <label>Photo</label>
          <div class="photo-uploader">
            <div class="photo-box" id="photoBox">
              <span class="photo-placeholder" id="photoPlaceholder">üñºÔ∏è</span>
              <img src="" id="staffPhoto" style="display:none;" alt="Photo">
            </div>
            <input type="file" id="photoInput" name="photo" accept="image/*">
          </div>
        </div>
        <div style="flex:3;">
          <div class="form-row">
            <div class="form-group">
              <label>First Name</label>
              <input type="text" name="first_name" required>
            </div>
            <div class="form-group">
              <label>Last Name</label>
              <input type="text" name="last_name" required>
            </div>
            <div class="form-group">
              <label>Other Name(s)</label>
              <input type="text" name="other_names">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Gender</label>
              <select name="gender" required>
                <option value="">Select</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Date of Birth</label>
              <input type="date" name="dob" required>
            </div>
            <div class="form-group">
              <label>Marital Status</label>
              <select name="marital_status" required>
                <option value="">Select</option>
                <option>Single</option>
                <option>Married</option>
                <option>Divorced</option>
                <option>Widowed</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Home Address</label>
          <input type="text" name="address" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" name="phone" required placeholder="+234...">
        </div>
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" name="email" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Designation</label>
          <select name="designation" required>
            <option value="">Select</option>
            <option>Teacher</option>
            <option>Head Teacher</option>
            <option>Principal</option>
            <option>Assistant</option>
            <option>Admin Officer</option>
            <option>Bursar</option>
            <option>Librarian</option>
            <option>Counselor</option>
            <option>Security</option>
            <option>Cleaner</option>
            <option>Driver</option>
            <option>Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Department</label>
          <input type="text" name="department" required>
        </div>
        <div class="form-group">
          <label>Staff Type</label>
          <select name="staff_type" required>
            <option value="">Select</option>
            <option>Teaching</option>
            <option>Non-Teaching</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Date Joined</label>
          <input type="date" name="date_joined" required>
        </div>
        <div class="form-group">
          <label>Highest Qualification</label>
          <input type="text" name="qualification" required>
        </div>
        <div class="form-group">
          <label>Years of Experience</label>
          <input type="text" name="experience" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Previous Employer/School</label>
          <input type="text" name="previous_employer">
        </div>
        <div class="form-group">
          <label>Specialization/Subjects</label>
          <input type="text" name="specialization" placeholder="e.g. English, Mathematics">
        </div>
      </div>
      <div class="note">Provide at least one valid identification.</div>
      <div class="form-row">
        <div class="form-group">
          <label>ID Type</label>
          <select name="id_type" required>
            <option value="">Select</option>
            <option>National ID</option>
            <option>Voter's Card</option>
            <option>International Passport</option>
            <option>Driver's License</option>
            <option>School ID</option>
            <option>Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>ID Number</label>
          <input type="text" name="id_number" required>
        </div>
        <div class="form-group">
          <label>ID Upload</label>
          <input type="file" name="id_upload" accept="image/*,application/pdf">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" name="kin_name" required>
        </div>
        <div class="form-group">
          <label>Relationship</label>
          <input type="text" name="kin_relationship" required>
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" name="kin_phone" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Address</label>
          <input type="text" name="kin_address">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Bank Name</label>
          <input type="text" name="bank_name" required>
        </div>
        <div class="form-group">
          <label>Account Name</label>
          <input type="text" name="account_name" required>
        </div>
        <div class="form-group">
          <label>Account Number</label>
          <input type="text" name="account_number" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Pension Scheme</label>
          <input type="text" name="pension" placeholder="Optional">
        </div>
        <div class="form-group">
          <label>Tax ID (TIN)</label>
          <input type="text" name="tax_id" placeholder="Optional">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" name="emergency_name" required>
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" name="emergency_phone" required>
        </div>
        <div class="form-group">
          <label>Relationship</label>
          <input type="text" name="emergency_relationship" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Email (for portal login)</label>
          <input type="email" name="login_email" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" name="login_password" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Access Level</label>
          <select name="access_level" required>
            <option value="">Select</option>
            <option>Teacher</option>
            <option>Head Teacher</option>
            <option>Principal</option>
            <option>HR</option>
            <option>Account/Admin</option>
          </select>
        </div>
      </div>
      <div class="form-actions">
        <button type="submit">Submit Enrollment</button>
      </div>
      <!-- End of original form content -->
    </form>
  </div>
  <!-- View Staff Section -->
  <div class="form-section staff-list-section" id="tab-view">
    <div class="staff-list-header">
      <div style="font-size:17px;font-weight:600;color:#007bff;">All Staff</div>
      <input type="text" class="staff-search" id="staffSearch" placeholder="Search staff...">
    </div>
    <div id="staffList">
      <div class="empty-staff-list">Loading staff...</div>
    </div>
  </div>
</div>
<!-- Staff Details Modal -->
<div class="modal-overlay" id="staffModal">
  <div class="modal-content" id="staffModalContent">
    <span class="modal-close" id="modalCloseBtn">&times;</span>
    <div id="modalBody">
      <!-- Dynamic content goes here -->
    </div>
  </div>
</div>
<script>
  // Tab navigation
  document.querySelectorAll('.form-tab').forEach(tab=>{
    tab.onclick = function() {
      document.querySelectorAll('.form-tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      document.querySelectorAll('.form-section').forEach(s=>s.classList.remove('active'));
      document.getElementById('tab-'+tab.dataset.tab).classList.add('active');
      window.scrollTo(0,0);
      if(tab.dataset.tab === 'view') loadStaffList();
    }
  });

  // Photo uploader (enroll form)
  document.getElementById('photoInput').onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
      document.getElementById('staffPhoto').src = ev.target.result;
      document.getElementById('staffPhoto').style.display = 'block';
      document.getElementById('photoPlaceholder').style.display = 'none';
    }
    reader.readAsDataURL(file);
  };

  // Submit handler (enroll form)
  document.getElementById('staffEnrollForm').onsubmit = async function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);

    // Show loading state (optional)
    const submitBtn = form.querySelector('button[type="submit"]');
    const origText = submitBtn.textContent;
    submitBtn.textContent = 'Submitting...';
    submitBtn.disabled = true;

    try {
      // Update the endpoint below to your backend route for staff enrollment
      const response = await fetch('/api/staff', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const errorData = await response.json();
        alert('Error: ' + (errorData.error || response.statusText));
      } else {
        const respData = await response.json();
        alert(respData.message || 'Staff enrollment successful!');
        form.reset();
        // Reset the photo box UI
        document.getElementById('staffPhoto').style.display = 'none';
        document.getElementById('photoPlaceholder').style.display = '';
        // Return to first tab
        document.querySelectorAll('.form-tab').forEach(t=>t.classList.remove('active'));
        document.querySelector('.form-tab[data-tab="enroll"]').classList.add('active');
        document.querySelectorAll('.form-section').forEach(s=>s.classList.remove('active'));
        document.getElementById('tab-enroll').classList.add('active');
      }
    } catch (err) {
      alert('Network or server error: ' + err.message);
    } finally {
      submitBtn.textContent = origText;
      submitBtn.disabled = false;
    }
  }

  // -------- STAFF LIST + MODAL --------
  let staffDataCache = [];

  async function loadStaffList() {
    const staffListDiv = document.getElementById('staffList');
    staffListDiv.innerHTML = '<div class="empty-staff-list">Loading staff...</div>';
    try {
      const resp = await fetch('/api/staff');
      if (!resp.ok) throw new Error('Failed to fetch staff list');
      const staff = await resp.json();
      staffDataCache = staff;
      renderStaffList(staff);
    } catch (err) {
      staffListDiv.innerHTML = '<div class="empty-staff-list">Could not load staff. Please try again.</div>';
    }
  }

  function renderStaffList(staff) {
    const staffListDiv = document.getElementById('staffList');
    if (!staff || staff.length === 0) {
      staffListDiv.innerHTML = '<div class="empty-staff-list">No staff found.</div>';
      return;
    }
    let html = '<table class="staff-table"><thead><tr><th></th><th>Name</th><th>Designation</th><th>Department</th></tr></thead><tbody>';
    for(const s of staff) {
      html += `<tr data-id="${s.id}">
        <td><img src="${s.photo_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent((s.first_name||'')+' '+(s.last_name||'')) + '&background=007bff&color=fff'}" class="staff-avatar" alt="Staff"></td>
        <td>${s.first_name || ''} ${s.last_name || ''}</td>
        <td>${s.designation || ''}</td>
        <td>${s.department || ''}</td>
      </tr>`;
    }
    html += '</tbody></table>';
    staffListDiv.innerHTML = html;
    // Add click handlers
    staffListDiv.querySelectorAll('tbody tr').forEach(row=>{
      row.onclick = ()=>showStaffModal(row.dataset.id);
    });
  }

  // Staff search
  document.getElementById('staffSearch').oninput = function() {
    const q = this.value.trim().toLowerCase();
    const filtered = staffDataCache.filter(s =>
      ((s.first_name||'') + ' ' + (s.last_name||'')).toLowerCase().includes(q) ||
      (s.designation||'').toLowerCase().includes(q) ||
      (s.department||'').toLowerCase().includes(q)
    );
    renderStaffList(filtered);
  };

  // Modal logic
  const staffModal = document.getElementById('staffModal');
  const modalCloseBtn = document.getElementById('modalCloseBtn');
  modalCloseBtn.onclick = ()=>{ staffModal.classList.remove('active'); };
  staffModal.onclick = function(e){ if(e.target===staffModal) staffModal.classList.remove('active'); };

  async function showStaffModal(id) {
    const modalBody = document.getElementById('modalBody');
    modalBody.innerHTML = '<div style="text-align:center;padding:36px;">Loading...</div>';
    staffModal.classList.add('active');
    try {
      // Fetch staff details
      const resp = await fetch(`/api/staff/${id}`);
      if (!resp.ok) throw new Error('Failed to fetch staff details');
      const s = await resp.json();
      // Compose modal content
      modalBody.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:12px;">
          <img class="modal-photo" src="${s.photo_url||'https://ui-avatars.com/api/?name=' + encodeURIComponent((s.first_name||'')+' '+(s.last_name||'')) + '&background=007bff&color=fff'}" alt="Staff Photo">
          <div class="modal-title">${s.first_name||''} ${s.last_name||''}</div>
          <div style="color:#555;text-align:center;">${s.designation||''} &middot; ${s.department||''}</div>
        </div>
        <div class="modal-section">
          <div class="modal-section-title">Basic Details</div>
          <div class="modal-details">
            <label>Other Name(s):</label><span>${s.other_names||'-'}</span>
            <label>Gender:</label><span>${s.gender||'-'}</span>
            <label>Date of Birth:</label><span>${s.dob||'-'}</span>
            <label>Marital Status:</label><span>${s.marital_status||'-'}</span>
          </div>
        </div>
        <div class="modal-section">
          <div class="modal-section-title">Contact</div>
          <div class="modal-details">
            <label>Phone:</label><span>${s.phone||'-'}</span>
            <label>Email:</label><span>${s.email||'-'}</span>
            <label>Address:</label><span>${s.address||'-'}</span>
          </div>
        </div>
        <div class="modal-section">
          <div class="modal-section-title">Employment</div>
          <div class="modal-details">
            <label>Staff Type:</label><span>${s.staff_type||'-'}</span>
            <label>Date Joined:</label><span>${s.date_joined||'-'}</span>
            <label>Qualification:</label><span>${s.qualification||'-'}</span>
            <label>Experience:</label><span>${s.experience||'-'}</span>
            <label>Previous Employer:</label><span>${s.previous_employer||'-'}</span>
            <label>Specialization/Subjects:</label><span>${s.specialization||'-'}</span>
          </div>
        </div>
        <div class="modal-section">
          <div class="modal-section-title">Identification</div>
          <div class="modal-details">
            <label>ID Type:</label><span>${s.id_type||'-'}</span>
            <label>ID Number:</label><span>${s.id_number||'-'}</span>
            ${s.id_upload_url?`<label>ID Upload:</label><span><a href="${s.id_upload_url}" target="_blank" style="color:#007bff;text-decoration:underline;">View ID</a></span>`:''}
          </div>
        </div>
        <div class="modal-section">
          <div class="modal-section-title">Next of Kin</div>
          <div class="modal-details">
            <label>Name:</label><span>${s.kin_name||'-'}</span>
            <label>Relationship:</label><span>${s.kin_relationship||'-'}</span>
            <label>Phone:</label><span>${s.kin_phone||'-'}</span>
            <label>Address:</label><span>${s.kin_address||'-'}</span>
          </div>
        </div>
        <div class="modal-section">
          <div class="modal-section-title">Bank Details</div>
          <div class="modal-details">
            <label>Bank Name:</label><span>${s.bank_name||'-'}</span>
            <label>Account Name:</label><span>${s.account_name||'-'}</span>
            <label>Account Number:</label><span>${s.account_number||'-'}</span>
            <label>Pension Scheme:</label><span>${s.pension||'-'}</span>
            <label>Tax ID:</label><span>${s.tax_id||'-'}</span>
          </div>
        </div>
        <div class="modal-section">
          <div class="modal-section-title">Emergency Contact</div>
          <div class="modal-details">
            <label>Name:</label><span>${s.emergency_name||'-'}</span>
            <label>Phone:</label><span>${s.emergency_phone||'-'}</span>
            <label>Relationship:</label><span>${s.emergency_relationship||'-'}</span>
          </div>
        </div>
        <div class="modal-section">
          <div class="modal-section-title">Portal Login</div>
          <div class="modal-details">
            <label>Email:</label><span>${s.login_email||'-'}</span>
            <label>Access Level:</label><span>${s.access_level||'-'}</span>
          </div>
        </div>
      `;
    } catch (err) {
      modalBody.innerHTML = '<div style="color:#b00;text-align:center;padding:36px;">Could not load staff details.</div>';
    }
  }

  // Optionally, load staff list on first page load
loadStaffList();
</script>
</body>
</html>
