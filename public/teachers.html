<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Staff Management | School Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS CDN (for Flowbite) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Flowbite CSS & JS -->
  <link href="https://unpkg.com/flowbite@2.3.0/dist/flowbite.min.css" rel="stylesheet">
  <script src="https://unpkg.com/flowbite@2.3.0/dist/flowbite.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
  <!-- Header -->
  <header class="bg-blue-900 text-white py-5 shadow">
    <div class="max-w-5xl mx-auto px-4 flex items-center gap-4">
      <div class="bg-white rounded-lg w-14 h-14 flex items-center justify-center text-2xl font-bold text-blue-900 shadow">
        SP
      </div>
      <div>
        <div class="text-2xl font-bold tracking-wide">GOLD AND LINC SCHOOLS</div>
        <div class="text-sm opacity-80">Professional Staff Management & Records</div>
      </div>
    </div>
  </header>
  <main class="max-w-5xl mx-auto my-8 bg-white rounded-xl shadow p-6">
    <!-- Tabs -->
    <ul class="flex flex-wrap text-sm font-medium text-center text-gray-500 border-b border-gray-200 mb-6" id="tablist" role="tablist">
      <li class="mr-2">
        <button id="tab-enroll-tab" data-tabs-target="#tab-enroll" type="button" role="tab" aria-controls="tab-enroll" aria-selected="true" class="inline-block p-4 rounded-t-lg border-b-2 active text-blue-900 border-blue-900">Enroll Staff</button>
      </li>
      <li class="mr-2">
        <button id="tab-view-tab" data-tabs-target="#tab-view" type="button" role="tab" aria-controls="tab-view" aria-selected="false" class="inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-blue-900 hover:border-blue-300">View Staff</button>
      </li>
    </ul>
    <!-- Tab panels -->
    <div id="tab-enroll" role="tabpanel" aria-labelledby="tab-enroll-tab">
      <form id="staffEnrollForm" class="space-y-8" enctype="multipart/form-data" autocomplete="off">
        <!-- Personal Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Photo</label>
            <div class="flex flex-col items-center gap-3">
              <div class="w-24 h-24 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center">
                <img id="staffPhoto" class="w-24 h-24 object-cover rounded-lg hidden" src="" alt="Staff photo">
                <span id="photoPlaceholder" class="text-gray-300 text-4xl">&#128247;</span>
              </div>
              <input type="file" id="photoInput" name="photo" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:bg-blue-50 file:text-blue-700" />
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-900">First Name</label>
              <input type="text" name="first_name" required class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
            </div>
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-900">Last Name</label>
              <input type="text" name="last_name" required class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
            </div>
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-900">Other Name(s)</label>
              <input type="text" name="other_names" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
            </div>
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-900">Gender</label>
              <select name="gender" class="form-select block w-full rounded-lg border-gray-300 focus:border-blue-500">
                <option value="">Select</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-900">Date of Birth</label>
              <input type="date" name="dob" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
            </div>
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-900">Marital Status</label>
              <select name="marital_status" class="form-select block w-full rounded-lg border-gray-300 focus:border-blue-500">
                <option value="">Select</option>
                <option>Single</option>
                <option>Married</option>
                <option>Divorced</option>
                <option>Widowed</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="block mb-2 text-sm font-medium text-gray-900">Home Address</label>
              <input type="text" name="address" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Phone Number</label>
            <input type="tel" name="phone" placeholder="+234..." class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Email Address</label>
            <input type="email" name="email" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Designation</label>
            <select name="designation" class="form-select block w-full rounded-lg border-gray-300 focus:border-blue-500">
              <option value="">Select</option>
              <option>Teacher</option>
              <option>Head Teacher</option>
              <option>Principal</option>
              <option>Assistant</option>
              <option>Admin Officer</option>
              <option>Bursar</option>
              <option>Librarian</option>
              <option>Counselor</option>
              <option>Security</option>
              <option>Cleaner</option>
              <option>Driver</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Department</label>
            <input type="text" name="department" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Staff Type</label>
            <select name="staff_type" required class="form-select block w-full rounded-lg border-gray-300 focus:border-blue-500">
              <option value="">Select</option>
              <option>Teaching</option>
              <option>Non-Teaching</option>
            </select>
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Date Joined</label>
            <input type="date" name="date_joined" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Highest Qualification</label>
            <input type="text" name="qualification" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Years of Experience</label>
            <input type="text" name="experience" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Previous Employer/School</label>
            <input type="text" name="previous_employer" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Specialization/Subjects</label>
            <input type="text" name="specialization" placeholder="e.g. English, Mathematics" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
          </div>
        </div>
        <div class="text-gray-500 text-sm">Provide at least one valid identification.</div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">ID Type</label>
            <select name="id_type" class="form-select block w-full rounded-lg border-gray-300 focus:border-blue-500">
              <option value="">Select</option>
              <option>National ID</option>
              <option>Voter's Card</option>
              <option>International Passport</option>
              <option>Driver's License</option>
              <option>School ID</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">ID Number</label>
            <input type="text" name="id_number" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">ID Upload</label>
            <input type="file" name="id_upload" accept="image/*,application/pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:bg-blue-50 file:text-blue-700" />
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Bank Name</label>
            <input type="text" name="bank_name" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Account Name</label>
            <input type="text" name="account_name" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Account Number</label>
            <input type="text" name="account_number" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Pension Scheme</label>
            <input type="text" name="pension" placeholder="Optional" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Tax ID (TIN)</label>
            <input type="text" name="tax_id" placeholder="Optional" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
          </div>
        </div>
        <div class="pt-2 border-t border-gray-200 mt-4">
          <div class="text-lg font-semibold text-blue-900 mb-3 mt-5">Next of Kin</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-900">Full Name</label>
              <input type="text" name="kin_name" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
            </div>
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-900">Relationship</label>
              <input type="text" name="kin_relationship" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
            </div>
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-900">Phone Number</label>
              <input type="tel" name="kin_phone" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
            </div>
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-900">Address</label>
            <input type="text" name="kin_address" class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
          </div>
        </div>
        <div class="pt-2 border-t border-gray-200 mt-4">
          <div class="text-lg font-semibold text-blue-900 mb-3 mt-5">Login Details</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-900">Email (for portal login)</label>
              <input type="email" name="login_email" required class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
            </div>
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-900">Password</label>
              <input type="password" name="login_password" required class="form-input block w-full rounded-lg border-gray-300 focus:border-blue-500" />
            </div>
            <div>
              <label class="block mb-2 text-sm font-medium text-gray-900">Access Level</label>
              <select name="access_level" required class="form-select block w-full rounded-lg border-gray-300 focus:border-blue-500">
                <option value="">Select</option>
                <option>Teacher</option>
                <option>Head Teacher</option>
                <option>Principal</option>
                <option>HR</option>
                <option>Account/Admin</option>
              </select>
            </div>
          </div>
        </div>
        <!-- Spinner and submit button -->
        <div id="enrollSpinner" class="hidden text-center my-3">
          <svg class="inline animate-spin w-8 h-8 text-blue-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
          <div class="text-blue-700 mt-2 text-sm">Submitting, please wait...</div>
        </div>
        <div class="text-right">
          <button type="submit" class="bg-blue-800 hover:bg-blue-900 text-white font-bold py-2 px-8 rounded-lg shadow focus:outline-none">Submit Enrollment</button>
        </div>
      </form>
    </div>
    <div class="hidden" id="tab-view" role="tabpanel" aria-labelledby="tab-view-tab">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-2">
        <div class="text-lg font-bold text-blue-900">All Staff</div>
        <input type="text" class="form-input w-full md:w-64 rounded-lg border-gray-300" id="staffSearch" placeholder="Search staff..." />
      </div>
      <div id="staffList">
        <div class="text-gray-400 text-center p-8">Loading staff...</div>
      </div>
    </div>
  </main>

  <!-- Staff Modal -->
  <div id="staffModal" tabindex="-1" aria-hidden="true"
    class="hidden fixed top-0 left-0 right-0 z-50 w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-modal md:h-full bg-black bg-opacity-40 flex items-start">
    <div class="relative w-full max-w-2xl mx-auto mt-16">
      <div class="bg-white rounded-lg shadow relative">
        <div class="flex justify-between items-center px-6 py-4 border-b rounded-t">
          <h3 class="text-xl font-semibold text-blue-900" id="modalTitle">Staff Details</h3>
          <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center" data-modal-hide="staffModal" id="modalCloseBtn">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
          </button>
        </div>
        <div class="p-6 overflow-y-auto max-h-[80vh]" id="modalBody">
          <!-- Dynamic content here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Flowbite & Custom JS -->
  <script>
    // --- Backend API base URL ---
    const API_BASE_URL = "https://goldlincschools.onrender.com";

    // Tab switching logic
    document.querySelectorAll('[data-tabs-target]').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('[role="tabpanel"]').forEach(panel => panel.classList.add('hidden'));
        document.querySelectorAll('[role="tab"]').forEach(t => {
          t.classList.remove('active', 'text-blue-900', 'border-blue-900');
          t.classList.add('hover:text-blue-900', 'hover:border-blue-300');
        });
        document.querySelector(this.getAttribute('data-tabs-target')).classList.remove('hidden');
        this.classList.add('active', 'text-blue-900', 'border-blue-900');
        this.classList.remove('hover:text-blue-900', 'hover:border-blue-300');
        if(this.getAttribute('data-tabs-target') === '#tab-view') loadStaffList();
      });
    });

    // Photo uploader (enroll form)
    document.getElementById('photoInput').onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        document.getElementById('staffPhoto').src = ev.target.result;
        document.getElementById('staffPhoto').classList.remove('hidden');
        document.getElementById('photoPlaceholder').classList.add('hidden');
      }
      reader.readAsDataURL(file);
    };

  // Utility to clean up and slugify full name for email
  function slugifyName(fullName) {
    return fullName
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, '') // remove special chars
      .replace(/\s+/g, '');        // remove spaces
  }

  // Form fields
  const firstNameInput = document.querySelector('input[name="first_name"]');
  const lastNameInput = document.querySelector('input[name="last_name"]');
  const otherNamesInput = document.querySelector('input[name="other_names"]');
  const loginEmailInput = document.querySelector('input[name="login_email"]');
  const loginPasswordInput = document.querySelector('input[name="login_password"]');

  // State trackers
  let emailManuallyEdited = false;
  let passwordManuallyEdited = false;

  // Listen to name changes for auto email generation
  function handleNameChange() {
    if (emailManuallyEdited) return;
    const fullName =
      (firstNameInput.value.trim() + " " +
      otherNamesInput.value.trim() + " " +
      lastNameInput.value.trim()).replace(/\s+/g, ' ').trim();
    const base = slugifyName(fullName);
    const generatedEmail = base ? (base + "@goldlincschools.com") : "";
    loginEmailInput.value = generatedEmail;
    // Also set password if not manually edited
    if (!passwordManuallyEdited) {
      loginPasswordInput.value = generatedEmail;
    }
  }

  firstNameInput.addEventListener('input', handleNameChange);
  lastNameInput.addEventListener('input', handleNameChange);
  otherNamesInput.addEventListener('input', handleNameChange);

  // Listen for manual email edit
  loginEmailInput.addEventListener('input', function() {
    emailManuallyEdited = true;
    if (!passwordManuallyEdited) {
      loginPasswordInput.value = loginEmailInput.value;
    }
  });

  loginEmailInput.addEventListener('change', function() {
    // If matches auto-generated, allow further auto, else lock
    const fullName =
      (firstNameInput.value.trim() + " " +
      otherNamesInput.value.trim() + " " +
      lastNameInput.value.trim()).replace(/\s+/g, ' ').trim();
    const base = slugifyName(fullName);
    const generatedEmail = base ? (base + "@goldlincschools.com") : "";
    emailManuallyEdited = (loginEmailInput.value !== generatedEmail);
  });

  // Listen for manual password edit
  loginPasswordInput.addEventListener('input', function() {
    passwordManuallyEdited = true;
  });

  loginPasswordInput.addEventListener('change', function() {
    passwordManuallyEdited = true;
  });

    // Staff enrollment form submission
    document.getElementById('staffEnrollForm').onsubmit = async function(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      // Show spinner, disable submit button
      const spinner = document.getElementById('enrollSpinner');
      spinner.classList.remove('hidden');
      const submitBtn = form.querySelector('button[type="submit"]');
      const origText = submitBtn.textContent;
      submitBtn.textContent = 'Submitting...';
      submitBtn.disabled = true;
      try {
        const response = await fetch(API_BASE_URL + '/api/staffs', {
          method: 'POST',
          body: formData
        });
        const respData = await response.json();
        if (!response.ok) {
          alert('Error: ' + (respData.error || response.statusText));
        } else {
          alert(respData.message || 'Staff enrollment successful!');
          form.reset();
          // Reset photo UI
          document.getElementById('staffPhoto').classList.add('hidden');
          document.getElementById('photoPlaceholder').classList.remove('hidden');
          // Optionally, switch tabs
          document.getElementById('tab-enroll-tab').click();
        }
      } catch (err) {
        alert('Network or server error: ' + err.message);
      } finally {
        spinner.classList.add('hidden');
        submitBtn.textContent = origText;
        submitBtn.disabled = false;
      }
    };

    // Staff list logic
    let staffDataCache = [];
    async function loadStaffList() {
      const staffListDiv = document.getElementById('staffList');
      staffListDiv.innerHTML = '<div class="text-gray-400 text-center p-8">Loading staff...</div>';
      try {
        const resp = await fetch(API_BASE_URL + '/api/staffs');
        if (!resp.ok) throw new Error('Failed to fetch staff list');
        const staff = await resp.json();
        staffDataCache = staff;
        renderStaffList(staff);
      } catch (err) {
        staffListDiv.innerHTML = '<div class="text-red-600 text-center p-8">Could not load staff. Please try again.</div>';
      }
    }
    function renderStaffList(staff) {
      const staffListDiv = document.getElementById('staffList');
      if (!staff || staff.length === 0) {
        staffListDiv.innerHTML = '<div class="text-gray-400 text-center p-8">No staff found.</div>';
        return;
      }
      let html = '<div class="overflow-x-auto"><table class="min-w-full text-sm text-left text-gray-700"><thead class="text-xs uppercase bg-blue-50 text-blue-900"><tr><th class="p-2"></th><th class="p-2">Name</th><th class="p-2">Designation</th><th class="p-2">Department</th></tr></thead><tbody>';
      for(const s of staff) {
        html += `<tr class="hover:bg-blue-50 cursor-pointer" data-id="${s.id}">
          <td class="p-2"><img src="${s.photo_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent((s.first_name||'')+' '+(s.last_name||'')) + '&background=457b9d&color=fff'}" class="w-10 h-10 rounded object-cover bg-gray-200" alt=""></td>
          <td class="p-2">${s.first_name || ''} ${s.last_name || ''}</td>
          <td class="p-2">${s.designation || ''}</td>
          <td class="p-2">${s.department || ''}</td>
        </tr>`;
      }
      html += '</tbody></table></div>';
      staffListDiv.innerHTML = html;
      // Add click handlers
      staffListDiv.querySelectorAll('tbody tr').forEach(row=>{
        row.onclick = ()=>showStaffModal(row.dataset.id);
      });
    }
    // Staff search
    document.getElementById('staffSearch').oninput = function() {
      const q = this.value.trim().toLowerCase();
      const filtered = staffDataCache.filter(s =>
        ((s.first_name||'') + ' ' + (s.last_name||'')).toLowerCase().includes(q) ||
        (s.designation||'').toLowerCase().includes(q) ||
        (s.department||'').toLowerCase().includes(q)
      );
      renderStaffList(filtered);
    };

    // Modal logic (Flowbite style)
    const staffModal = document.getElementById('staffModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    modalCloseBtn.onclick = ()=>{ staffModal.classList.add('hidden'); };
    staffModal.onclick = function(e){ if(e.target===staffModal) staffModal.classList.add('hidden'); };

    // --- Modal Edit/Delete Logic ---
    let editingStaffId = null;
    let originalStaffData = null;

    async function showStaffModal(id) {
      const modalBody = document.getElementById('modalBody');
      modalBody.innerHTML = '<div class="text-center py-8 text-gray-400">Loading...</div>';
      staffModal.classList.remove('hidden');
      try {
        const resp = await fetch(API_BASE_URL + `/api/staffs/${id}`);
        if (!resp.ok) throw new Error('Failed to fetch staff details');
        const s = await resp.json();
        // Render the modal as a simple editable form inline (fields are readonly by default)
        modalBody.innerHTML = `
          <div class="flex gap-2 justify-end mb-3">
            <button id="editTeacherBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold">Edit</button>
            <button id="deleteTeacherBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-semibold">Delete</button>
            <button id="saveTeacherBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-semibold hidden">Save</button>
            <button id="cancelEditTeacherBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg text-sm font-semibold hidden">Cancel</button>
          </div>
          <div class="flex flex-col md:flex-row md:items-center gap-6 mb-6">
            <img class="w-24 h-24 rounded-lg object-cover bg-gray-200 border" src="${s.photo_url||'https://ui-avatars.com/api/?name=' + encodeURIComponent((s.first_name||'')+' '+(s.last_name||'')) + '&background=457b9d&color=fff'}" alt="Staff photo">
            <div>
              <input name="first_name" data-editable readonly value="${s.first_name||''}" class="text-2xl font-bold text-blue-900 bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" />
              <input name="last_name" data-editable readonly value="${s.last_name||''}" class="text-2xl font-bold text-blue-900 bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" />
              <div class="text-blue-700">${s.designation||''} &middot; ${s.department||''}</div>
              <div class="mt-2 text-gray-500 text-sm">Staff Type: <input name="staff_type" data-editable readonly value="${s.staff_type||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /> | Joined: <input name="date_joined" data-editable readonly value="${s.date_joined||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
            <div>
              <div class="font-semibold mb-2 text-blue-800">Basic Details</div>
              <div class="mb-1"><span class="font-medium">Other Name(s):</span> <input name="other_names" data-editable readonly value="${s.other_names||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">Gender:</span> <input name="gender" data-editable readonly value="${s.gender||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">DOB:</span> <input name="dob" data-editable readonly value="${s.dob||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">Marital Status:</span> <input name="marital_status" data-editable readonly value="${s.marital_status||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
            </div>
            <div>
              <div class="font-semibold mb-2 text-blue-800">Contact</div>
              <div class="mb-1"><span class="font-medium">Phone:</span> <input name="phone" data-editable readonly value="${s.phone||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">Email:</span> <input name="email" data-editable readonly value="${s.email||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">Address:</span> <input name="address" data-editable readonly value="${s.address||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
            </div>
            <div>
              <div class="font-semibold mb-2 text-blue-800">Employment</div>
              <div class="mb-1"><span class="font-medium">Qualification:</span> <input name="qualification" data-editable readonly value="${s.qualification||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">Experience:</span> <input name="experience" data-editable readonly value="${s.experience||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">Previous Employer:</span> <input name="previous_employer" data-editable readonly value="${s.previous_employer||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">Specialization:</span> <input name="specialization" data-editable readonly value="${s.specialization||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
            </div>
            <div>
              <div class="font-semibold mb-2 text-blue-800">Identification</div>
              <div class="mb-1"><span class="font-medium">ID Type:</span> <input name="id_type" data-editable readonly value="${s.id_type||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">ID Number:</span> <input name="id_number" data-editable readonly value="${s.id_number||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              ${s.id_upload_url?`<div class="mb-1"><span class="font-medium">ID Upload:</span> <a href="${s.id_upload_url}" target="_blank" class="text-blue-600 underline">View ID</a></div>`:''}
            </div>
            <div>
              <div class="font-semibold mb-2 text-blue-800">Next of Kin</div>
              <div class="mb-1"><span class="font-medium">Name:</span> <input name="kin_name" data-editable readonly value="${s.kin_name||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">Relationship:</span> <input name="kin_relationship" data-editable readonly value="${s.kin_relationship||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">Phone:</span> <input name="kin_phone" data-editable readonly value="${s.kin_phone||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">Address:</span> <input name="kin_address" data-editable readonly value="${s.kin_address||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
            </div>
            <div>
              <div class="font-semibold mb-2 text-blue-800">Bank Details</div>
              <div class="mb-1"><span class="font-medium">Bank Name:</span> <input name="bank_name" data-editable readonly value="${s.bank_name||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">Account Name:</span> <input name="account_name" data-editable readonly value="${s.account_name||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">Account Number:</span> <input name="account_number" data-editable readonly value="${s.account_number||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">Pension:</span> <input name="pension" data-editable readonly value="${s.pension||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">Tax ID:</span> <input name="tax_id" data-editable readonly value="${s.tax_id||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
            </div>
            <div>
              <div class="font-semibold mb-2 text-blue-800">Portal Login</div>
              <div class="mb-1"><span class="font-medium">Email:</span> <input name="login_email" data-editable readonly value="${s.login_email||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
              <div class="mb-1"><span class="font-medium">Access Level:</span> <input name="access_level" data-editable readonly value="${s.access_level||''}" class="bg-transparent border-none focus:border-blue-400 focus:bg-blue-50" /></div>
            </div>
          </div>
          <label class="inline-flex items-center mt-2 hidden">
            <input type="checkbox" id="updatePasswordToggle" class="mr-2"> Update Password
          </label>
          <input type="password" id="editPasswordInput" class="form-input block w-full rounded-lg border-gray-300 mt-2 hidden" placeholder="New password (leave blank to keep current)" />
        `;
        modalBody.dataset.staffId = id;

        // Attach edit/delete/save/cancel logic
        document.getElementById('editTeacherBtn').onclick = function () {
          editingStaffId = modalBody.dataset.staffId;
          // Save original values
          originalStaffData = {};
          modalBody.querySelectorAll('[data-editable]').forEach(input => {
            originalStaffData[input.name] = input.value;
            input.removeAttribute('readonly');
            input.classList.add('border-blue-400', 'bg-blue-50');
          });
          document.getElementById('editTeacherBtn').classList.add('hidden');
          document.getElementById('deleteTeacherBtn').classList.add('hidden');
          document.getElementById('saveTeacherBtn').classList.remove('hidden');
          document.getElementById('cancelEditTeacherBtn').classList.remove('hidden');
          document.getElementById('updatePasswordToggle').parentElement.classList.remove('hidden');
        };
        document.getElementById('cancelEditTeacherBtn').onclick = function () {
          modalBody.querySelectorAll('[data-editable]').forEach(input => {
            input.value = originalStaffData[input.name] || '';
            input.setAttribute('readonly', true);
            input.classList.remove('border-blue-400', 'bg-blue-50');
          });
          document.getElementById('editTeacherBtn').classList.remove('hidden');
          document.getElementById('deleteTeacherBtn').classList.remove('hidden');
          document.getElementById('saveTeacherBtn').classList.add('hidden');
          document.getElementById('cancelEditTeacherBtn').classList.add('hidden');
          document.getElementById('updatePasswordToggle').checked = false;
          document.getElementById('updatePasswordToggle').parentElement.classList.add('hidden');
          document.getElementById('editPasswordInput').classList.add('hidden');
          document.getElementById('editPasswordInput').value = '';
        };
        document.getElementById('updatePasswordToggle').onchange = function () {
          if (this.checked) {
            document.getElementById('editPasswordInput').classList.remove('hidden');
          } else {
            document.getElementById('editPasswordInput').classList.add('hidden');
            document.getElementById('editPasswordInput').value = '';
          }
        };
        document.getElementById('saveTeacherBtn').onclick = async function () {
          let updateData = {};
          modalBody.querySelectorAll('[data-editable]').forEach(input => {
            updateData[input.name] = input.value;
          });
          // Optionally add password
          if (document.getElementById('updatePasswordToggle').checked) {
            const password = document.getElementById('editPasswordInput').value;
            if (password) updateData.login_password = password;
          }
          try {
            const resp = await fetch(`${API_BASE_URL}/api/staffs/${editingStaffId}`, {
              method: 'PATCH',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(updateData),
            });
            const resData = await resp.json();
            if (!resp.ok) return alert('Update failed: ' + (resData.error || resp.statusText));
            alert('Update successful!');
            showStaffModal(editingStaffId);
          } catch (err) {
            alert('Network error: ' + err.message);
          }
          // Exit edit mode
          document.getElementById('cancelEditTeacherBtn').onclick();
        };
        document.getElementById('deleteTeacherBtn').onclick = async function () {
          if (!confirm('Are you sure you want to delete this teacher/staff?')) return;
          try {
            const resp = await fetch(`${API_BASE_URL}/api/staffs/${modalBody.dataset.staffId}`, { method: 'DELETE' });
            if (!resp.ok) return alert('Delete failed!');
            alert('Deleted!');
            staffModal.classList.add('hidden');
            loadStaffList();
          } catch (err) {
            alert('Network error: ' + err.message);
          }
        };
      } catch (err) {
        modalBody.innerHTML = '<div class="text-red-600 text-center py-8">Could not load staff details.</div>';
      }
    }
  </script>
</body>
</html>
